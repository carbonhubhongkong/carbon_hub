(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1311:(e,t,a)=>{Promise.resolve().then(a.bind(a,8981))},6953:()=>{},8981:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>O});var s=a(5155),i=a(2115),r=a(3568),o=a(7652),n=a(7642),l=a(6284);a(6953);let c=()=>{let{locale:e,setLocale:t}=(0,n.s)(),[a,r]=(0,i.useState)(!1),o=(0,i.useRef)(null);(0,i.useEffect)(()=>{let e=e=>{o.current&&!o.current.contains(e.target)&&r(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]);let c=e=>{t(e),r(!1)},d=l.L$[e];return(0,s.jsxs)("div",{className:"language-selector",ref:o,children:[(0,s.jsxs)("button",{className:"language-selector-button",onClick:()=>r(!a),"aria-label":"Select language","aria-expanded":a,"aria-haspopup":"listbox",children:[(0,s.jsx)("span",{className:"language-name",children:d}),(0,s.jsx)("span",{className:"language-arrow ".concat(a?"open":""),children:"▼"})]}),a&&(0,s.jsx)("div",{className:"language-dropdown",role:"listbox",children:l.IB.map(t=>(0,s.jsxs)("button",{className:"language-option ".concat(t===e?"selected":""),onClick:()=>c(t),role:"option","aria-selected":t===e,children:[(0,s.jsx)("span",{className:"language-name",children:l.L$[t]}),t===e&&(0,s.jsx)("span",{className:"checkmark",children:"✓"})]},t))})]})},d=()=>(0,s.jsxs)("div",{className:"logo",children:[(0,s.jsx)("div",{className:"logo-container",children:(0,s.jsx)("img",{src:"/carbon-hub-logo-3.png",alt:"Carbon Hub Logo",width:120,height:75,className:"logo-image"})}),(0,s.jsx)(c,{})]}),m=e=>{let{currentStage:t,onStageClick:a}=e,r=(0,o.c3)(),n=[{id:1,title:r("navigation.stage1"),description:r("stage1.description")},{id:2,title:r("navigation.stage2"),description:r("stage2.description")},{id:3,title:r("navigation.stage3"),description:r("stage3.description")}];return(0,s.jsx)("div",{className:"stepper",children:(0,s.jsx)("div",{className:"stepper-container",children:n.map((e,r)=>(0,s.jsxs)(i.Fragment,{children:[(0,s.jsxs)("div",{className:"stepper-step ".concat(t===e.id?"active":""," ").concat(t>e.id?"completed":""),onClick:()=>a(e.id),children:[(0,s.jsx)("div",{className:"stepper-circle",children:t>e.id?(0,s.jsx)("span",{className:"checkmark",children:"✓"}):(0,s.jsx)("span",{className:"step-number",children:e.id})}),(0,s.jsxs)("div",{className:"stepper-content",children:[(0,s.jsx)("h3",{className:"stepper-title",children:e.title}),(0,s.jsx)("p",{className:"stepper-description",children:e.description})]})]}),r<n.length-1&&(0,s.jsx)("div",{className:"stepper-line ".concat(t>e.id?"completed":"")})]},e.id))})})};var u=a(9911),g=a(408),h=a.n(g);let p=[{key:"description",label:"Description",type:"string",required:!0,allowEmpty:!1,example:"Grid electricity, Hong Kong"},{key:"scope",label:"Scope",type:"enum",required:!0,allowEmpty:!1,validation:{enumOptions:["Scope 1","Scope 2","Scope 3"]},example:"Scope 2"},{key:"category",label:"Category",type:"string",required:!0,allowEmpty:!1,example:"Electricity"},{key:"location",label:"Country/Region/Location",type:"string",required:!0,allowEmpty:!1,example:"Hong Kong"},{key:"unit",label:"Unit on Quantity",type:"string",required:!0,allowEmpty:!1,example:"kWh"},{key:"dataSource",label:"Data Source/Collection Method",type:"string",required:!0,allowEmpty:!1,example:"Utility bill"},{key:"methodType",label:"Method Type",type:"enum",required:!0,allowEmpty:!1,validation:{enumOptions:["Volume Based","Spend Based","Distance Based","Mass Based"]},example:"Volume Based"},{key:"co2ePerUnit",label:"CO2e per Unit",type:"number",required:!0,allowEmpty:!1,validation:{min:0},example:.81},{key:"emissionFactorUnit",label:"Emission Factor Unit",type:"string",required:!0,allowEmpty:!1,example:"kg CO2e/kWh"},{key:"ghgReportingStandard",label:"GHG Reporting Standard",type:"enum",required:!0,allowEmpty:!1,validation:{enumOptions:["GHG Protocol","GRI Standards","ISO 14064","IFRS - ISSB","Custom"]},example:"GHG Protocol"},{key:"sourceOrDisclosureRequirement",label:"Source or Disclosure Requirement",type:"string",required:!0,allowEmpty:!0,example:"https://www.epd.gov.hk/epd/english/climate_change/files/EF_2022.pdf"}],f=e=>{var t,a,r,l,c,d;let{isOpen:m,onClose:u,factor:g,onUpdate:h,ghgStandards:f}=e,y=(0,o.c3)(),{locale:x}=(0,n.s)(),[v,b]=(0,i.useState)(0),[j,N]=(0,i.useState)({description:"",scope:"",category:"",location:"",unit:"",dataSource:"",methodType:"Volume Based",co2ePerUnit:0,emissionFactorUnit:"",ghgReportingStandard:"",sourceOrDisclosureRequirement:""}),[S,F]=(0,i.useState)({}),[E,D]=(0,i.useState)({}),[k,A]=(0,i.useState)(!1);(0,i.useEffect)(()=>{b(e=>e+1)},[x]),(0,i.useEffect)(()=>{g&&(console.log("EditEmissionFactorModal: Initializing with factor data:",g),console.log("EditEmissionFactorModal: co2ePerUnit type:",typeof g.co2ePerUnit,"value:",g.co2ePerUnit),p.forEach(e=>{let t=g[e.key];console.log("EditEmissionFactorModal: Field ".concat(e.key,":"),{value:t,type:typeof t,required:e.required})}),N(g),F({}))},[g]),(0,i.useEffect)(()=>{if(Object.keys(S).length>0){let e={};Object.keys(S).forEach(t=>{let a=j[t];if(void 0!==a){let s=C(t,a);s&&(e[t]=s)}}),F(e)}},[x,y]);let C=(e,t)=>{let a=p.find(t=>t.key===e);if(!a)return null;if(a.required){if("number"===a.type){if(null==t||"number"==typeof t&&isNaN(t))return y("stage1.validation.fieldRequired",{fieldName:a.label})}else if(null==t||"string"==typeof t&&""===t.trim()&&!a.allowEmpty)return y("stage1.validation.fieldRequired",{fieldName:a.label})}if(a.validation){if(void 0!==a.validation.min&&"number"==typeof t&&t<a.validation.min)return y("stage1.validation.minValue",{fieldName:a.label,min:a.validation.min});if(void 0!==a.validation.max&&"number"==typeof t&&t>a.validation.max)return y("stage1.validation.maxValue",{fieldName:a.label,max:a.validation.max});if(a.validation.regex&&"string"==typeof t&&!new RegExp(a.validation.regex).test(t))return a.validation.customError||y("stage1.validation.invalidFormat",{fieldName:a.label});if(a.validation.enumOptions&&"string"==typeof t&&!a.validation.enumOptions.includes(t))return y("stage1.validation.enumError",{options:a.validation.enumOptions.join(", ")})}return null},I=(e,t)=>{N(a=>({...a,[e]:t})),S[e]&&F(t=>({...t,[e]:null}))},w=e=>{D(t=>({...t,[e]:!0}))},R=e=>{D(t=>({...t,[e]:!1}));let t=j[e];if(void 0!==t){let a=C(e,t);F(t=>({...t,[e]:a}))}},T=e=>{let t=p.find(t=>t.key===e);return t?(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:y("stage1.formLabels.".concat(e))}),(0,s.jsx)("br",{}),y("common.example"),": ",t.example]}):""},B=async e=>{e.preventDefault(),console.log("EditEmissionFactorModal: Submitting form data:",j);let t={};if(p.forEach(e=>{let a=j[e.key];if(console.log("EditEmissionFactorModal: Validating ".concat(e.key,":"),{value:a,type:typeof a,required:e.required}),void 0!==a){let s=C(e.key,a);s&&(t[e.key]=s,console.log("EditEmissionFactorModal: Validation error for ".concat(e.key,":"),s))}}),console.log("EditEmissionFactorModal: Validation errors:",t),Object.keys(t).some(e=>null!==t[e]))return void F(t);A(!0);try{await h(j),u()}catch(e){console.error("Error updating emission factor:",e)}finally{A(!1)}};return m&&g?(0,s.jsx)("div",{className:"modal-overlay",onClick:u,children:(0,s.jsxs)("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[(0,s.jsx)("div",{className:"modal-header",children:(0,s.jsx)("h3",{className:"modal-title",children:y("stage1.editEmissionFactorTitle")})}),(0,s.jsxs)("form",{onSubmit:B,className:"modal-body",children:[(0,s.jsxs)("div",{className:"form-section",children:[(0,s.jsx)("h4",{className:"section-title",children:y("stage1.generalInfoTitle")}),(0,s.jsxs)("div",{className:"form-grid",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-description",children:[y("stage1.formLabels.description")," *"]}),(0,s.jsx)("input",{type:"text",id:"modal-description",name:"description",value:j.description,onChange:e=>I("description",e.target.value),onFocus:()=>w("description"),onBlur:()=>R("description"),required:!0,className:"form-input ".concat(S.description?"form-input-error":"")}),E.description&&(0,s.jsx)("div",{className:"form-tooltip",children:T("description")}),S.description&&(0,s.jsx)("div",{className:"form-error-message",children:S.description})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-scope",children:[y("stage1.formLabels.scope")," *"]}),(0,s.jsxs)("select",{id:"modal-scope",name:"scope",value:j.scope,onChange:e=>I("scope",e.target.value),onFocus:()=>w("scope"),onBlur:()=>R("scope"),required:!0,className:"form-input ".concat(S.scope?"form-input-error":""),children:[(0,s.jsx)("option",{value:"",children:y("stage1.selectScope")}),null==(r=p.find(e=>"scope"===e.key))||null==(a=r.validation)||null==(t=a.enumOptions)?void 0:t.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),E.scope&&(0,s.jsx)("div",{className:"form-tooltip",children:T("scope")}),S.scope&&(0,s.jsx)("div",{className:"form-error-message",children:S.scope})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-category",children:[y("stage1.formLabels.category")," *"]}),(0,s.jsx)("input",{type:"text",id:"modal-category",name:"category",value:j.category,onChange:e=>I("category",e.target.value),onFocus:()=>w("category"),onBlur:()=>R("category"),required:!0,className:"form-input ".concat(S.category?"form-input-error":"")}),E.category&&(0,s.jsx)("div",{className:"form-tooltip",children:T("category")}),S.category&&(0,s.jsx)("div",{className:"form-error-message",children:S.category})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-location",children:[y("stage1.formLabels.location")," *"]}),(0,s.jsx)("input",{type:"text",id:"modal-location",name:"location",value:j.location,onChange:e=>I("location",e.target.value),onFocus:()=>w("location"),onBlur:()=>R("location"),required:!0,className:"form-input ".concat(S.location?"form-input-error":"")}),E.location&&(0,s.jsx)("div",{className:"form-tooltip",children:T("location")}),S.location&&(0,s.jsx)("div",{className:"form-error-message",children:S.location})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-unit",children:[y("stage1.formLabels.unit")," *"]}),(0,s.jsx)("input",{type:"text",id:"modal-unit",name:"unit",value:j.unit,onChange:e=>I("unit",e.target.value),onFocus:()=>w("unit"),onBlur:()=>R("unit"),required:!0,className:"form-input ".concat(S.unit?"form-input-error":"")}),E.unit&&(0,s.jsx)("div",{className:"form-tooltip",children:T("unit")}),S.unit&&(0,s.jsx)("div",{className:"form-error-message",children:S.unit})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-dataSource",children:[y("stage1.formLabels.dataSource")," *"]}),(0,s.jsx)("input",{type:"text",id:"modal-dataSource",name:"dataSource",value:j.dataSource,onChange:e=>I("dataSource",e.target.value),onFocus:()=>w("dataSource"),onBlur:()=>R("dataSource"),required:!0,className:"form-input ".concat(S.dataSource?"form-input-error":"")}),E.dataSource&&(0,s.jsx)("div",{className:"form-tooltip",children:T("dataSource")}),S.dataSource&&(0,s.jsx)("div",{className:"form-error-message",children:S.dataSource})]})]})]}),(0,s.jsxs)("div",{className:"form-section",children:[(0,s.jsx)("h4",{className:"section-title",children:y("stage1.calculationMethodsTitle")}),(0,s.jsx)("div",{className:"form-grid",children:(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-methodType",children:[y("stage1.formLabels.methodType")," *"]}),(0,s.jsx)("select",{id:"modal-methodType",name:"methodType",value:j.methodType,onChange:e=>I("methodType",e.target.value),onFocus:()=>w("methodType"),onBlur:()=>R("methodType"),required:!0,className:"form-input ".concat(S.methodType?"form-input-error":""),children:null==(d=p.find(e=>"methodType"===e.key))||null==(c=d.validation)||null==(l=c.enumOptions)?void 0:l.map(e=>(0,s.jsx)("option",{value:e,children:e},e))}),E.methodType&&(0,s.jsx)("div",{className:"form-tooltip",children:T("methodType")}),S.methodType&&(0,s.jsx)("div",{className:"form-error-message",children:S.methodType})]})})]}),(0,s.jsxs)("div",{className:"form-section",children:[(0,s.jsx)("h4",{className:"section-title",children:y("stage1.emissionFactorReferenceTitle")}),(0,s.jsxs)("div",{className:"form-grid",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-co2ePerUnit",children:[y("stage1.formLabels.co2ePerUnit")," *"]}),(0,s.jsx)("input",{type:"number",id:"modal-co2ePerUnit",name:"co2ePerUnit",value:j.co2ePerUnit,onChange:e=>I("co2ePerUnit",parseFloat(e.target.value)||0),onFocus:()=>w("co2ePerUnit"),onBlur:()=>R("co2ePerUnit"),step:"0.01",min:"0",required:!0,className:"form-input ".concat(S.co2ePerUnit?"form-input-error":"")}),E.co2ePerUnit&&(0,s.jsx)("div",{className:"form-tooltip",children:T("co2ePerUnit")}),S.co2ePerUnit&&(0,s.jsx)("div",{className:"form-error-message",children:S.co2ePerUnit})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-emissionFactorUnit",children:[y("stage1.formLabels.emissionFactorUnit")," *"]}),(0,s.jsx)("input",{type:"text",id:"modal-emissionFactorUnit",name:"emissionFactorUnit",value:j.emissionFactorUnit,onChange:e=>I("emissionFactorUnit",e.target.value),onFocus:()=>w("emissionFactorUnit"),onBlur:()=>R("emissionFactorUnit"),required:!0,className:"form-input ".concat(S.emissionFactorUnit?"form-input-error":"")}),E.emissionFactorUnit&&(0,s.jsx)("div",{className:"form-tooltip",children:T("emissionFactorUnit")}),S.emissionFactorUnit&&(0,s.jsx)("div",{className:"form-error-message",children:S.emissionFactorUnit})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-ghgReportingStandard",children:[y("stage1.formLabels.ghgReportingStandard")," *"]}),(0,s.jsxs)("select",{id:"modal-ghgReportingStandard",name:"ghgReportingStandard",value:j.ghgReportingStandard,onChange:e=>I("ghgReportingStandard",e.target.value),onFocus:()=>w("ghgReportingStandard"),onBlur:()=>R("ghgReportingStandard"),required:!0,className:"form-input ".concat(S.ghgReportingStandard?"form-input-error":""),children:[(0,s.jsx)("option",{value:"",children:y("stage1.selectStandard")}),f.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),E.ghgReportingStandard&&(0,s.jsx)("div",{className:"form-tooltip",children:T("ghgReportingStandard")}),S.ghgReportingStandard&&(0,s.jsx)("div",{className:"form-error-message",children:S.ghgReportingStandard})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-sourceOrDisclosureRequirement",children:[y("stage1.formLabels.sourceOrDisclosureRequirement")," *"]}),(0,s.jsx)("input",{type:"text",id:"modal-sourceOrDisclosureRequirement",name:"sourceOrDisclosureRequirement",value:j.sourceOrDisclosureRequirement,onChange:e=>I("sourceOrDisclosureRequirement",e.target.value),onFocus:()=>w("sourceOrDisclosureRequirement"),onBlur:()=>R("sourceOrDisclosureRequirement"),required:!0,className:"form-input ".concat(S.sourceOrDisclosureRequirement?"form-input-error":""),placeholder:y("stage1.placeholders.sourceOrDisclosureRequirement")}),E.sourceOrDisclosureRequirement&&(0,s.jsx)("div",{className:"form-tooltip",children:T("sourceOrDisclosureRequirement")}),S.sourceOrDisclosureRequirement&&(0,s.jsx)("div",{className:"form-error-message",children:S.sourceOrDisclosureRequirement})]})]})]})]}),(0,s.jsxs)("div",{className:"modal-actions",children:[(0,s.jsx)("button",{type:"button",onClick:u,className:"btn btn-secondary modal-btn",disabled:k,children:y("common.cancel")}),(0,s.jsx)("button",{type:"submit",onClick:B,className:"btn btn-primary modal-btn",disabled:k,children:k?y("stage1.updating"):y("stage1.update")})]})]})}):null},y=e=>{let{data:t,selectedRows:a,onRowSelect:i,onSelectAll:r,onEdit:n,onDelete:l,onBulkDelete:c,isDeleting:d=!1,showBulkDelete:m=!0,tableType:g,rowErrors:h={}}=e,f=(0,o.c3)(),y=t.length>0&&a.size===t.length,x=a.size>0,v=(e,t)=>"csv"===g?t:e._id,b=e=>"csv"===g&&Object.keys(h[e]||{}).length>0,j=(e,t)=>{var a;return"csv"===g&&(null==(a=h[e])?void 0:a[t])?"csv-cell-error":""},N=(e,t)=>{switch(t){case"description":return e.description;case"scope":return e.scope;case"category":return e.category;case"location":return e.location;case"unit":return e.unit;case"dataSource":return e.dataSource;case"methodType":return e.methodType;case"co2ePerUnit":return e.co2ePerUnit;case"emissionFactorUnit":return e.emissionFactorUnit;case"ghgReportingStandard":return e.ghgReportingStandard;case"sourceOrDisclosureRequirement":return e.sourceOrDisclosureRequirement;default:return"N/A"}};return(0,s.jsxs)("div",{className:"table-container",children:[t.length>0&&m&&(0,s.jsx)("div",{className:"bulk-actions",children:(0,s.jsxs)("div",{className:"bulk-controls",children:[(0,s.jsxs)("label",{className:"select-all-checkbox",children:[(0,s.jsx)("input",{type:"checkbox",checked:y,onChange:e=>r(e.target.checked)}),(0,s.jsx)("span",{children:f("common.selectAll")})]}),x&&(0,s.jsx)("button",{type:"button",onClick:c,className:"btn btn-danger btn-small",disabled:d,children:d?f("common.deleting"):f("common.deleteSelected",{count:a.size})})]})}),(0,s.jsxs)("table",{className:"unified-table ".concat("csv"===g?"csv-table":"data-table"),children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"checkbox-column",children:(0,s.jsx)("input",{type:"checkbox",checked:y,onChange:e=>r(e.target.checked)})}),p.map(e=>(0,s.jsx)("th",{children:f("stage1.formLabels.".concat(e.key))},e.key)),"csv"===g&&(0,s.jsx)("th",{}),(0,s.jsx)("th",{children:f("common.actions")})]})}),(0,s.jsx)("tbody",{children:t.map((e,t)=>{let r=v(e,t),o=a.has(r),c=b(t);return(0,s.jsxs)("tr",{className:"csv"===g&&c?"csv-row-invalid":"",children:[(0,s.jsx)("td",{className:"checkbox-column",children:(0,s.jsx)("input",{type:"checkbox",checked:o,onChange:e=>i(r,e.target.checked)})}),p.map(a=>{var i;return(0,s.jsx)("td",{className:j(t,a.key),title:"csv"===g&&(null==(i=h[t])?void 0:i[a.key])?h[t][a.key]:"",children:"co2ePerUnit"===a.key?"".concat(e.co2ePerUnit," ").concat(e.emissionFactorUnit):"sourceOrDisclosureRequirement"===a.key&&e.sourceOrDisclosureRequirement&&/^https?:\/\//.test(e.sourceOrDisclosureRequirement.trim())?(0,s.jsx)("a",{href:e.sourceOrDisclosureRequirement,target:"_blank",rel:"noopener noreferrer",children:e.sourceOrDisclosureRequirement}):N(e,a.key)},a.key)}),"csv"===g&&(0,s.jsx)("td",{children:c&&(0,s.jsx)("span",{className:"csv-caution",title:f("csvManager.rowHasErrors"),children:"⚠️"})}),(0,s.jsx)("td",{className:"actions-column",children:(0,s.jsxs)("div",{className:"action-buttons",children:[(0,s.jsxs)("button",{onClick:()=>n(e),className:"btn btn-small btn-secondary",title:f("common.editEmissionFactor"),children:[(0,s.jsx)(u.uO9,{})," ",f("common.edit")]}),(0,s.jsxs)("button",{onClick:()=>l(e),className:"btn btn-small btn-danger",title:f("common.deleteEmissionFactor"),disabled:d,children:[(0,s.jsx)(u.qbC,{})," ",f("common.delete")]})]})})]},r)})})]})]})};class x{async init(){return console.log("IndexedDB: Initializing database..."),new Promise((e,t)=>{let a=indexedDB.open(this.dbName,this.version);a.onerror=()=>{console.error("IndexedDB: Database initialization error:",a.error),t(a.error)},a.onsuccess=()=>{this.db=a.result,console.log("IndexedDB: Database initialized successfully"),e()},a.onupgradeneeded=e=>{console.log("IndexedDB: Database upgrade needed, creating object stores...");let t=e.target.result;if(!t.objectStoreNames.contains("reporting_activities")){console.log("IndexedDB: Creating reporting_activities store");let e=t.createObjectStore("reporting_activities",{keyPath:"_id",autoIncrement:!0});e.createIndex("scope","scope",{unique:!1}),e.createIndex("category","category",{unique:!1}),e.createIndex("location","location",{unique:!1})}if(!t.objectStoreNames.contains("emission_factors")){console.log("IndexedDB: Creating emission_factors store");let e=t.createObjectStore("emission_factors",{keyPath:"_id",autoIncrement:!0});e.createIndex("scope","scope",{unique:!1}),e.createIndex("category","category",{unique:!1}),e.createIndex("location","location",{unique:!1})}t.objectStoreNames.contains("ghg_reporting_standards")||(console.log("IndexedDB: Creating ghg_reporting_standards store"),t.createObjectStore("ghg_reporting_standards",{keyPath:"_id",autoIncrement:!0}).createIndex("name","name",{unique:!0})),console.log("IndexedDB: Object stores created successfully")}})}async ensureInit(){this.db?console.log("IndexedDB: Database already initialized"):(console.log("IndexedDB: Database not initialized, initializing now..."),await this.init())}async add(e,t){return await this.ensureInit(),console.log("IndexedDB: Adding item to ".concat(e,":"),t),new Promise((a,s)=>{let i=this.db.transaction([e],"readwrite").objectStore(e).add(t);i.onsuccess=()=>{console.log("IndexedDB: Item added to ".concat(e," with ID:"),i.result),a(i.result)},i.onerror=()=>{console.error("IndexedDB: Error adding item to ".concat(e,":"),i.error),s(i.error)}})}async get(e,t){return await this.ensureInit(),console.log("IndexedDB: Getting item from ".concat(e," with ID:"),t),new Promise((a,s)=>{let i=this.db.transaction([e],"readonly").objectStore(e).get(t);i.onsuccess=()=>{console.log("IndexedDB: Retrieved item from ".concat(e,":"),i.result),a(i.result||null)},i.onerror=()=>{console.error("IndexedDB: Error getting item from ".concat(e,":"),i.error),s(i.error)}})}async getAll(e){return await this.ensureInit(),console.log("IndexedDB: Getting all items from ".concat(e)),new Promise((t,a)=>{let s=this.db.transaction([e],"readonly").objectStore(e).getAll();s.onsuccess=()=>{var a;console.log("IndexedDB: Retrieved ".concat((null==(a=s.result)?void 0:a.length)||0," items from ").concat(e)),t(s.result||[])},s.onerror=()=>{console.error("IndexedDB: Error getting all items from ".concat(e,":"),s.error),a(s.error)}})}async update(e,t){return await this.ensureInit(),console.log("IndexedDB: Updating item in ".concat(e,":"),t),new Promise((a,s)=>{let i=this.db.transaction([e],"readwrite").objectStore(e).put(t);i.onsuccess=()=>{console.log("IndexedDB: Item updated in ".concat(e," successfully")),a()},i.onerror=()=>{console.error("IndexedDB: Error updating item in ".concat(e,":"),i.error),s(i.error)}})}async delete(e,t){return await this.ensureInit(),new Promise((a,s)=>{let i=this.db.transaction([e],"readwrite").objectStore(e).delete(t);i.onsuccess=()=>a(),i.onerror=()=>s(i.error)})}async clear(e){return await this.ensureInit(),new Promise((t,a)=>{let s=this.db.transaction([e],"readwrite").objectStore(e).clear();s.onsuccess=()=>t(),s.onerror=()=>a(s.error)})}async addReportingActivity(e){console.log("IndexedDB: Adding reporting activity:",e);let t=await this.add("reporting_activities",e);return console.log("IndexedDB: Activity added with ID:",t),t}async getReportingActivity(e){console.log("IndexedDB: Getting reporting activity with ID:",e);let t=await this.get("reporting_activities",e);return console.log("IndexedDB: Retrieved activity:",t),t}async getAllReportingActivities(){console.log("IndexedDB: Getting all reporting activities");let e=await this.getAll("reporting_activities");return console.log("IndexedDB: Retrieved activities:",e),e}async updateReportingActivity(e){console.log("IndexedDB: Updating reporting activity:",e),await this.update("reporting_activities",e),console.log("IndexedDB: Activity updated successfully")}async deleteReportingActivity(e){console.log("IndexedDB: Deleting reporting activity with ID:",e),await this.delete("reporting_activities",e),console.log("IndexedDB: Activity deleted successfully")}async addEmissionFactor(e){console.log("IndexedDB: Adding emission factor:",e);let t=await this.add("emission_factors",e);return console.log("IndexedDB: Emission factor added with ID:",t),t}async getEmissionFactor(e){console.log("IndexedDB: Getting emission factor with ID:",e);let t=await this.get("emission_factors",e);return console.log("IndexedDB: Retrieved emission factor:",t),t}async getAllEmissionFactors(){console.log("IndexedDB: Getting all emission factors");let e=await this.getAll("emission_factors");return console.log("IndexedDB: Retrieved emission factors:",e),e}async updateEmissionFactor(e){console.log("IndexedDB: Updating emission factor:",e),await this.update("emission_factors",e),console.log("IndexedDB: Emission factor updated successfully")}async deleteEmissionFactor(e){console.log("IndexedDB: Deleting emission factor with ID:",e),await this.delete("emission_factors",e),console.log("IndexedDB: Emission factor deleted successfully")}async addGhgReportingStandard(e){return await this.add("ghg_reporting_standards",e)}async getAllGhgReportingStandards(){return this.getAll("ghg_reporting_standards")}async seedDefaultData(){try{let e=await this.getAllGhgReportingStandards();if(0===e.length){for(let e of[{name:"GHG Protocol"},{name:"GRI Standards"},{name:"ISO 14064"},{name:"IFRS - ISSB"},{name:"Custom"}])await this.addGhgReportingStandard(e);console.log("Default GHG reporting standards seeded")}}catch(e){console.error("Error seeding default data:",e)}}async clearAllData(){try{await this.clear("reporting_activities"),await this.clear("emission_factors"),await this.clear("ghg_reporting_standards"),console.log("All data cleared successfully")}catch(e){throw console.error("Error clearing data:",e),e}}async exportData(){try{let[e,t,a]=await Promise.all([this.getAllReportingActivities(),this.getAllEmissionFactors(),this.getAllGhgReportingStandards()]);return{reporting_activities:e,emission_factors:t,ghg_reporting_standards:a}}catch(e){throw console.error("Error exporting data:",e),e}}async importData(e){try{for(let t of(await this.clearAllData(),e.ghg_reporting_standards))await this.addGhgReportingStandard(t);for(let t of e.emission_factors){let{_id:e,...a}=t;await this.addEmissionFactor(a)}for(let t of e.reporting_activities){let{_id:e,...a}=t;await this.addReportingActivity(a)}console.log("Data imported successfully")}catch(e){throw console.error("Error importing data:",e),e}}constructor(){this.dbName="CarbonHubDB",this.version=1,this.db=null}}let v=new x;function b(e){let t={};for(let a of p){let s=e[a.key];a.required&&("number"===a.type?(null==s||isNaN(Number(s)))&&(t[a.key]="".concat(a.label," is required and must be a valid number")):null!=s&&("string"!=typeof s||""!==s.trim()||a.allowEmpty)||(t[a.key]="".concat(a.label," is required"))),a.validation&&(a.validation.enumOptions&&"string"==typeof s&&""!==s.trim()&&!a.validation.enumOptions.includes(s)&&(t[a.key]="".concat(a.label," must be one of: ").concat(a.validation.enumOptions.join(", "))),void 0!==a.validation.min&&"number"==typeof s&&s<a.validation.min&&(t[a.key]="".concat(a.label," must be at least ").concat(a.validation.min)),void 0!==a.validation.max&&"number"==typeof s&&s>a.validation.max&&(t[a.key]="".concat(a.label," must be at most ").concat(a.validation.max)),a.validation.regex&&"string"==typeof s&&""!==s.trim()&&!new RegExp(a.validation.regex).test(s)&&(t[a.key]=a.validation.customError||"".concat(a.label," format is invalid")))}return Object.keys(t).length>0&&(console.log("Validation errors for row:",t),console.log("Row data:",e)),t}v.init().then(()=>{v.seedDefaultData()}).catch(e=>{console.error("Failed to initialize IndexedDB:",e)});let j=e=>{let{onImportSuccess:t,onCSVLoaded:a,importSectionRef:l}=e,c=(0,o.c3)(),{locale:d}=(0,n.s)(),[m,g]=(0,i.useState)(0),[x,j]=(0,i.useState)([]),[N,S]=(0,i.useState)(new Set),[F,E]=(0,i.useState)({}),[D,k]=(0,i.useState)(""),[A,C]=(0,i.useState)(!1),[I,w]=(0,i.useState)(0),[R,T]=(0,i.useState)(null),[B,q]=(0,i.useState)(!1),[O,L]=(0,i.useState)(!1),[P,U]=(0,i.useState)(null),[M,_]=(0,i.useState)(null),G=(0,i.useRef)(null);i.useEffect(()=>{x.length>0&&(console.log("CSV rows changed, ensuring validation state is consistent..."),console.log("Current csvRows:",x),console.log("Current rowErrors:",F),Y(x),Q()||(console.warn("Validation state inconsistency detected, forcing refresh..."),setTimeout(()=>Y(x),100)),Object.keys(F).some(e=>{let t=parseInt(e);return t>=0&&t<x.length&&0===Object.keys(b(x[t])).length&&Object.keys(F[t]||{}).length>0})&&(console.warn("False validation errors detected, cleaning up..."),Z()))},[x.length]),(0,i.useEffect)(()=>{g(e=>e+1)},[d]),(0,i.useEffect)(()=>{if(Object.keys(F).length>0&&x.length>0){let e={};Object.keys(F).forEach(t=>{let a=parseInt(t);if(a>=0&&a<x.length){let t=b(x[a]);Object.keys(t).length>0&&(e[a]=t)}}),E(e)}},[d,c]);let V=e=>{h().parse(e,{header:!0,skipEmptyLines:!0,complete:e=>{if(e.errors.length>0)return void k("CSV parsing errors: ".concat(e.errors.map(e=>e.message).join(", ")));let t=e.data;if(0===t.length)return void k("CSV file is empty or contains only headers");let s=function(e){let t=[],a=p.map(e=>e.label),s=a.filter(t=>!e.some(e=>e.trim().toLowerCase()===t.toLowerCase()));s.length>0&&t.push("Missing required columns: ".concat(s.join(", ")));let i=e.filter(e=>!a.some(t=>e.trim().toLowerCase()===t.toLowerCase()));i.length>0&&t.push("Unexpected columns found: ".concat(i.join(", ")));let r=e.map(e=>e.trim().toLowerCase()),o=a.map(e=>e.toLowerCase());return JSON.stringify(r)!==JSON.stringify(o)&&t.push("Column order does not match expected template. Please use the provided CSV template."),{isValid:0===t.length,errors:t}}(e.meta.fields||[]);if(!s.isValid)return void k("CSV header validation failed: ".concat(s.errors.join("; ")));let i=t.filter(e=>Object.values(e).some(e=>e&&""!==e.trim()&&!p.some(t=>t.label.toLowerCase()===e.trim().toLowerCase()))).map(e=>(function(e){let t={};return p.forEach(a=>{var s;let i=null!=(s=e[a.label])?s:"";("unit"===a.key||"emissionFactorUnit"===a.key)&&(console.log("Before conversion [".concat(a.key,']: "').concat(i,'"')),i=function(e){if(!e)return e;let t=e.normalize("NFC"),a={"\xb9":"1","\xb2":"2","\xb3":"3","⁴":"4","⁵":"5","⁶":"6","⁷":"7","⁸":"8","⁹":"9","⁰":"0","₁":"1","₂":"2","₃":"3","₄":"4","₅":"5","₆":"6","₇":"7","₈":"8","₉":"9","₀":"0",ᵢ:"i",ⱼ:"j",ₖ:"k",ₗ:"l",ₘ:"m",ₙ:"n",ₒ:"o",ₚ:"p",ᵣ:"r",ₛ:"s",ₜ:"t",ᵤ:"u",ᵥ:"v",ₓ:"x",ᵧ:"y",ᵦ:"z"};console.log('Original text: "'.concat(e,'"')),console.log('Normalized text: "'.concat(t,'"')),console.log("Character codes: ".concat(t.split("").map(e=>"".concat(e,"(").concat(e.charCodeAt(0),")")).join(" ")));let s=t;s.includes("")&&(console.log("Detected Unicode replacement character, attempting to fix..."),s=s.split("").map(e=>65533===e.charCodeAt(0)?"3":e).join(""),console.log('Fixed text: "'.concat(s,'"')));let i=s.split("").map(e=>{let t=a[e];if(t)return console.log('Converting: "'.concat(e,'" (').concat(e.charCodeAt(0),') → "').concat(t,'"')),t;let s=e.charCodeAt(0);return s>=8304&&s<=8351&&console.log('Found unmapped superscript/subscript: "'.concat(e,'" (').concat(s,")")),e}).join("");return e!==i&&console.log('Final conversion: "'.concat(e,'" → "').concat(i,'"')),i}(i),console.log("After conversion [".concat(a.key,']: "').concat(i,'"'))),t[a.key]=i}),{description:t.description||"",scope:t.scope||"",category:t.category||"",location:t.location||"",unit:t.unit||"",dataSource:t.dataSource||"",methodType:t.methodType||"Volume Based",co2ePerUnit:parseFloat(t.co2ePerUnit)||0,emissionFactorUnit:t.emissionFactorUnit||"",ghgReportingStandard:t.ghgReportingStandard||"",sourceOrDisclosureRequirement:t.sourceOrDisclosureRequirement||""}})(e));if(0===i.length)return void k("No valid data rows found in CSV. Please ensure your CSV contains data rows after the header.");j(i),Y(i),k(""),a&&(console.log("CSV data loaded, triggering onCSVLoaded callback..."),setTimeout(()=>{a()},100))},error:e=>{k("Error parsing CSV: ".concat(e.message))}})},W=e=>{U(e),_(x[e]),L(!0)},z=()=>{L(!1),U(null),_(null),x.length>0&&Y(x)},H=async()=>{if(0!==N.size){q(!0);try{let e=Array.from(N).sort((e,t)=>t-e),t=[...x];e.forEach(e=>{t.splice(e,1)}),j(t),S(new Set),Y(t)}catch(e){console.error("Error deleting rows:",e),k(c("csvManager.failedToDeleteSelectedRows"))}finally{q(!1)}}},J=async()=>{if(Object.keys(F).length>0)return void k("Please fix all validation errors before importing");C(!0),w(0),T(null);try{let e=0,a=0;for(let t=0;t<x.length;t++){let s=x[t];try{await v.addEmissionFactor(s),e++}catch(e){a++,console.error("Error importing row ".concat(t+1,":"),e)}w((t+1)/x.length*100)}T({added:e,failed:a}),0===a?(j([]),S(new Set),E({}),k(""),t&&(console.log("Import successful, triggering onImportSuccess callback..."),t()),r.toast.success(c("csvManager.importSuccess",{count:e,plural:e>1?"s":""}))):r.toast.error(c("csvManager.importFailed"))}catch(e){console.error("Import error:",e),k("Import failed"),r.toast.error(c("csvManager.importFailed"))}finally{C(!1),w(0)}},Y=e=>{let t={};return e.forEach((e,a)=>{let s=b(e);Object.keys(s).length>0?(t[a]=s,console.log("Row ".concat(a," validation errors:"),s)):console.log("Row ".concat(a," is valid"))}),console.log("Total validation errors:",Object.keys(t).length),console.log("Current rowErrors state:",F),E(t),t},$=e=>{E(t=>{let a={...t};return delete a[e],a})},K=()=>{let e=Object.keys(F).length>0,t=x.length>0,a=!A,s=Object.entries(F).map(e=>{let[t,a]=e;return{rowIndex:parseInt(t),errorCount:Object.keys(a).length,errors:a}});console.log("Import button state:",{hasErrors:e,hasRows:t,isNotImporting:a,rowErrorsCount:Object.keys(F).length,csvRowsCount:x.length,importing:A,errorDetails:s});let i=s.filter(e=>e.errorCount>0),r=i.length>0;console.log("Actual error analysis:",{hasActualErrors:r,actualErrors:i});let o=!1;return r&&(o=i.some(e=>{let t=e.rowIndex;return t>=0&&t<x.length&&Object.keys(b(x[t])).length>0})),console.log("Validation verification:",{hasValidErrors:o,shouldEnable:!o&&t&&a}),!o&&t&&a},Q=()=>{if(0===x.length)return!0;let e=Object.keys(Y(x)),t=Object.keys(F);if(e.length!==t.length)return console.log("Validation state inconsistency detected:"),console.log("Current validation errors:",e),console.log("State validation errors:",t),!1;for(let a of e)if(!t.includes(a))return console.log("Validation state inconsistency: key ".concat(a," missing from state")),!1;return!0},Z=()=>{if(console.log("Ensuring clean validation state..."),0===x.length)return void E({});E({}),setTimeout(()=>{Y(x)},100)},X=()=>{if(console.log("Auto-fixing validation state inconsistencies..."),0===x.length)return void E({});let e={};x.forEach((t,a)=>{let s=b(t);Object.keys(s).length>0&&(e[a]=s)}),console.log("Auto-fix result:",{oldErrorCount:Object.keys(F).length,newErrorCount:Object.keys(e).length,newErrors:e}),E(e)},ee=()=>{if(console.log("Performing comprehensive validation check..."),0===x.length)return void E({});E({}),setTimeout(()=>{let e={};x.forEach((t,a)=>{let s=b(t);Object.keys(s).length>0?(e[a]=s,console.log("Row ".concat(a," has ").concat(Object.keys(s).length," validation errors:"),s)):console.log("Row ".concat(a," is valid"))}),console.log("Comprehensive validation result:",{totalRows:x.length,rowsWithErrors:Object.keys(e).length,newErrors:e}),E(e),setTimeout(()=>{console.log("Final Import button state after comprehensive check:",K())},100)},100)},et=()=>{if(console.log("Ensuring Import button is in correct state..."),0===x.length)return void console.log("No CSV rows, Import button should be disabled");let e=Object.keys(F).length,t=K();console.log("Import button state check:",{currentErrors:e,shouldBeEnabled:t,csvRowsCount:x.length}),t||0!==e?t&&e>0?(console.warn("Import button should be disabled but is not. Clearing false errors..."),Z()):console.log("Import button state is correct"):(console.warn("Import button should be enabled but is not. Performing comprehensive check..."),ee())},ea=()=>{console.log("Performing final validation check...");let e=!1;Object.keys(F).forEach(t=>{let a=parseInt(t);a>=0&&a<x.length&&0===Object.keys(b(x[a])).length&&Object.keys(F[a]||{}).length>0&&(console.warn("False validation errors detected for row ".concat(a)),e=!0)}),e?(console.warn("False validation errors detected, performing cleanup..."),ee()):console.log("No false validation errors detected")};return(0,s.jsxs)("div",{className:"csv-manager",children:[(0,s.jsx)("div",{className:"csv-actions",children:(0,s.jsx)("button",{type:"button",className:"btn btn-secondary",onClick:()=>{let e=new Blob([function(){let e=p.map(e=>e.label),t=p.map(e=>e.example);return h().unparse({fields:e,data:[t]})}()],{type:"text/csv"}),t=window.URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="emission_factors_template.csv",a.click(),window.URL.revokeObjectURL(t)},children:c("csvManager.downloadTemplate")})}),(0,s.jsxs)("div",{className:"csv-dropzone",onDrop:e=>{e.preventDefault();let t=e.dataTransfer.files[0];t&&"text/csv"===t.type&&V(t)},onDragOver:e=>{e.preventDefault()},onClick:()=>{var e;return null==(e=G.current)?void 0:e.click()},tabIndex:0,"aria-label":"Upload CSV file",children:[(0,s.jsx)("input",{type:"file",accept:".csv,text/csv",ref:G,style:{display:"none"},onChange:e=>{var t;let a=null==(t=e.target.files)?void 0:t[0];a&&V(a)}}),(0,s.jsxs)("span",{children:[c("csvManager.dragDropText")," "]}),(0,s.jsx)("a",{href:"",onClick:()=>{var e;return null==(e=G.current)?void 0:e.click()},children:c("csvManager.clickToSelect")})]}),D&&(0,s.jsx)("div",{className:"csv-error",children:D}),(0,s.jsxs)("div",{className:"csv-info",children:[(0,s.jsx)("div",{className:"csv-info-header",children:(0,s.jsx)("h4",{children:c("csvManager.importInstructions.title")})}),(0,s.jsx)("div",{className:"csv-info-content",children:(0,s.jsxs)("ol",{children:[(0,s.jsx)("li",{children:c("csvManager.importInstructions.step1")}),(0,s.jsx)("li",{children:c("csvManager.importInstructions.step2")}),(0,s.jsx)("li",{dangerouslySetInnerHTML:{__html:c("csvManager.importInstructions.step3").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")}})]})})]}),x.length>0&&(0,s.jsx)(y,{data:x,selectedRows:N,onRowSelect:(e,t)=>{let a="string"==typeof e?parseInt(e):e;t?S(e=>new Set([...e,a])):S(e=>{let t=new Set(e);return t.delete(a),t})},onSelectAll:e=>{e?S(new Set(x.map((e,t)=>t))):S(new Set)},onEdit:e=>{let t=x.findIndex(t=>t.description===e.description&&t.scope===e.scope&&t.category===e.category);-1!==t&&W(t)},onDelete:e=>{let t=x.findIndex(t=>t.description===e.description&&t.scope===e.scope&&t.category===e.category);-1!==t&&(S(new Set([t])),H())},onBulkDelete:H,isDeleting:B,showBulkDelete:!0,tableType:"csv",rowErrors:F}),x.length>0&&(0,s.jsxs)("div",{className:"csv-import-actions",ref:l,children:[(0,s.jsx)("div",{className:"csv-import-info",children:(0,s.jsx)("span",{children:c("csvManager.readyToImport",{count:x.length,plural:x.length>1?"s":""})})}),(0,s.jsx)("button",{className:"btn btn-primary",onClick:J,disabled:!K(),children:A?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{className:"spinner"}),c("csvManager.importing")," ",Math.round(I),"%"]}):c("csvManager.importButton",{count:x.length,plural:x.length>1?"s":""})}),A&&(0,s.jsxs)("div",{className:"csv-progress-bar",children:[(0,s.jsx)("div",{className:"csv-progress-container",children:(0,s.jsx)("div",{className:"csv-progress",style:{width:"".concat(I,"%")}})}),(0,s.jsxs)("span",{className:"csv-progress-text",children:[c("csvManager.importing")," ",Math.round(I),"%"]})]}),R&&(0,s.jsxs)("div",{className:"csv-import-result",children:[(0,s.jsx)(u.CMH,{className:"csv-success"}),c("csvManager.importResult",{added:R.added,failed:R.failed})]})]}),(0,s.jsx)(f,{isOpen:O,onClose:z,factor:M,onUpdate:async e=>{if(null!==P){console.log("Updating row at index:",P),console.log("Updated factor data:",e);let t=[...x];t[P]=e,j(t),$(P),setTimeout(()=>{console.log("Re-validating after edit...");let a=b(e);console.log("Row ".concat(P," validation result:"),a),Object.keys(a).length>0?(E(e=>({...e,[P]:a})),console.log("Setting validation errors for edited row")):(E(e=>{let t={...e};return delete t[P],t}),console.log("Clearing validation errors for edited row")),Y(t),setTimeout(()=>{let e=K();console.log("Final Import button state check:",e),e||0!==Object.keys(a).length||(console.warn("Import button should be enabled but is not. Auto-fixing..."),X()),et(),ea()},200)},100),z()}},ghgStandards:["GHG Protocol","GRI Standards","ISO 14064","IFRS - ISSB","Custom"]})]})},N=e=>{let{isOpen:t,onClose:a,onConfirm:r,title:n,message:l,confirmText:c="Confirm",cancelText:d="Cancel",isBulkDelete:m=!1,selectedCount:u=0}=e,g=(0,o.c3)(),h=(0,i.useRef)(null),p=(0,i.useRef)(null);return((0,i.useEffect)(()=>{let e=e=>{"Escape"===e.key&&a()};return t&&(document.addEventListener("keydown",e),p.current&&p.current.focus()),()=>{document.removeEventListener("keydown",e)}},[t,a]),t)?(0,s.jsx)("div",{className:"modal-overlay",onClick:e=>{e.target===e.currentTarget&&a()},children:(0,s.jsxs)("div",{className:"modal-content delete-modal",ref:h,children:[(0,s.jsx)("div",{className:"modal-header",children:(0,s.jsx)("h2",{className:"modal-title",children:n})}),(0,s.jsx)("div",{className:"modal-body",children:(0,s.jsx)("p",{className:"delete-message",children:m?g("modals.deleteConfirmation.bulkDeleteMessage",{count:u,plural:u>1?"s":""}):l})}),(0,s.jsxs)("div",{className:"modal-actions",children:[(0,s.jsx)("button",{type:"button",className:"btn btn-secondary",onClick:a,children:d}),(0,s.jsx)("button",{ref:p,type:"button",className:"btn btn-danger",onClick:r,children:c})]})]})}):null},S=e=>{var t,a,l,c,d,m;let{onNext:u}=e,g=(0,o.c3)(),{locale:h}=(0,n.s)(),[x,b]=(0,i.useState)(0),[S,F]=(0,i.useState)({description:"",scope:"",category:"",location:"",unit:"",dataSource:"",methodType:"Volume Based",co2ePerUnit:0,emissionFactorUnit:"",ghgReportingStandard:"",sourceOrDisclosureRequirement:""}),[E,D]=(0,i.useState)([]),[k,A]=(0,i.useState)(!1),[C,I]=(0,i.useState)(!1),[w,R]=(0,i.useState)(!1),[T,B]=(0,i.useState)(null),[q,O]=(0,i.useState)(!1),[L,P]=(0,i.useState)(null),[U,M]=(0,i.useState)(!1),[_,G]=(0,i.useState)(new Set),[V,W]=(0,i.useState)(!1),[z,H]=(0,i.useState)([]),[J,Y]=(0,i.useState)({}),[$,K]=(0,i.useState)({}),Q=(0,i.useRef)(null),Z=(0,i.useRef)(null);(0,i.useEffect)(()=>{X(),ee()},[]),(0,i.useEffect)(()=>{b(e=>e+1)},[h]),(0,i.useEffect)(()=>{if(Object.keys(J).length>0){let e={};Object.keys(J).forEach(t=>{let a=S[t],s=et(t,a);s&&(e[t]=s)}),Y(e)}},[h,g]);let X=async()=>{try{let e=await v.getAllEmissionFactors();D(Array.isArray(e)?e:[])}catch(e){console.error("Error fetching emission factors:",e),r.toast.error(g("stage1.toast.fetchEmissionFactorsFailed")),D([])}},ee=async()=>{try{let e=(await v.getAllGhgReportingStandards()).map(e=>e.name);H(Array.isArray(e)?e:[])}catch(e){console.error("Error fetching GHG Reporting Standards:",e),r.toast.error(g("stage1.toast.fetchGhgStandardsFailed")),H([])}},et=(e,t)=>{let a=p.find(t=>t.key===e);if(!a||!a.required)return"";if("number"===a.type){if(null==t||isNaN(Number(t)))return g("stage1.validation.invalidNumber")}else if(null==t||"string"==typeof t&&""===t.trim()&&!a.allowEmpty)return g("stage1.validation.required");return a.validation&&a.validation.enumOptions&&"string"==typeof t&&!a.validation.enumOptions.includes(t)?g("stage1.validation.enumError",{options:a.validation.enumOptions.join(", ")}):""},ea=e=>{let{name:t,value:a}=e.target;F(e=>({...e,[t]:"co2ePerUnit"===t?parseFloat(a)||0:a}));let s=et(t,a);Y(e=>({...e,[t]:s}))},es=e=>{K(t=>({...t,[e]:!0}))},ei=e=>{K(t=>({...t,[e]:!1}));let t=S[e],a=et(e,t);Y(t=>({...t,[e]:a}))},er=e=>{if(!p.find(t=>t.key===e))return"";switch(e){case"description":return g("stage1.tooltips.description");case"scope":return g("stage1.tooltips.scope");case"category":return g("stage1.tooltips.category");case"location":return g("stage1.tooltips.location");case"unit":return g("stage1.tooltips.unit");case"dataSource":return g("stage1.tooltips.dataSource");case"methodType":return g("stage1.tooltips.methodType");case"co2ePerUnit":return g("stage1.tooltips.co2ePerUnit");case"emissionFactorUnit":return g("stage1.tooltips.emissionFactorUnit");case"ghgReportingStandard":return g("stage1.tooltips.ghgReportingStandard");case"sourceOrDisclosureRequirement":return g("stage1.tooltips.sourceOrDisclosureRequirement");default:return""}},eo=async e=>{e.preventDefault();let t={};if(p.forEach(e=>{if(e.required){let a=S[e.key];a&&("string"!=typeof a||""!==a.trim())||(t[e.key]=g("stage1.validation.fieldRequired",{fieldName:e.label}))}}),Object.keys(t).length>0)return void Object.values(t).forEach(e=>r.toast.error(e));try{let e=await v.addEmissionFactor(S),t={...S,_id:e};D(e=>[...e,t]),F({description:"",scope:"",category:"",location:"",unit:"",dataSource:"",methodType:"Volume Based",co2ePerUnit:0,emissionFactorUnit:"",ghgReportingStandard:"",sourceOrDisclosureRequirement:""}),r.toast.success(g("stage1.toast.addedSuccessfully"))}catch(e){console.error("Error adding emission factor:",e),r.toast.error(e instanceof Error?e.message:g("stage1.toast.addFailed"))}},en=async e=>{if(!e._id)return void r.toast.error(g("stage1.toast.cannotUpdateMissingId"));I(!0);try{await v.updateEmissionFactor(e),r.toast.success(g("stage1.toast.updatedSuccessfully")),X()}catch(e){console.error("Error updating emission factor:",e),r.toast.error("".concat(g("stage1.toast.updateFailed"),": ").concat(e instanceof Error?e.message:g("common.unknownError")))}finally{I(!1)}},el=async()=>{if(!(null==L?void 0:L._id))return void r.toast.error(g("stage1.toast.cannotDeleteMissingId"));W(!0);try{await v.deleteEmissionFactor(L._id),r.toast.success(g("stage1.toast.deletedSuccessfully")),X(),O(!1),P(null)}catch(e){console.error("Error deleting emission factor:",e),r.toast.error("".concat(g("stage1.toast.deleteFailed"),": ").concat(e instanceof Error?e.message:g("common.unknownError")))}finally{W(!1)}},ec=async()=>{if(0===_.size)return void r.toast.error(g("stage1.toast.noFactorsSelectedForDeletion"));W(!0);try{let e=Array.from(_).map(async e=>(await v.deleteEmissionFactor(e),{id:e,success:!0})),t=await Promise.allSettled(e),a=t.filter(e=>"fulfilled"===e.status).length,s=t.length-a;a>0?(r.toast.success(g("stage1.toast.bulkDeleteSuccess",{count:a,plural:a>1?"s":""})),s>0&&r.toast.error(g("stage1.toast.bulkDeleteFailed",{count:s,plural:s>1?"s":""})),X(),G(new Set)):r.toast.error(g("stage1.toast.bulkDeleteAllFailed")),M(!1)}catch(e){console.error("Error during bulk delete:",e),r.toast.error("".concat(g("stage1.toast.bulkDeleteFailed"),": ").concat(e instanceof Error?e.message:g("common.unknownError")))}finally{W(!1)}},ed=()=>{Z.current&&Z.current.scrollIntoView({behavior:"smooth",block:"start"})};return(0,s.jsxs)("div",{className:"stage",children:[(0,s.jsx)("h2",{className:"stage-title",children:g("stage1.importTitle")}),(0,s.jsx)(j,{onImportSuccess:()=>{X(),setTimeout(()=>{ed()},500)},onCSVLoaded:()=>{Q.current&&Q.current.scrollIntoView({behavior:"smooth",block:"end"})},importSectionRef:Q}),(0,s.jsx)("h1",{style:{textAlign:"center",marginBottom:"20px"},children:g("stage1.or")}),(0,s.jsx)("h2",{className:"stage-title",children:g("stage1.inputTitle")}),(0,s.jsxs)("form",{onSubmit:eo,className:"emission-form",children:[(0,s.jsxs)("div",{className:"form-section",children:[(0,s.jsx)("h3",{className:"section-title",children:g("stage1.generalInfoTitle")}),(0,s.jsxs)("div",{className:"form-grid",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"description",children:g("stage1.formLabels.description")}),(0,s.jsx)("input",{type:"text",id:"description",name:"description",value:S.description,onChange:ea,onFocus:()=>es("description"),onBlur:()=>ei("description"),required:!0,className:"form-input ".concat(J.description?"form-input-error":"")}),$.description&&(0,s.jsx)("div",{className:"form-tooltip",children:er("description")}),J.description&&(0,s.jsx)("div",{className:"form-error-message",children:J.description})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"scope",children:g("stage1.formLabels.scope")}),(0,s.jsxs)("select",{id:"scope",name:"scope",value:S.scope,onChange:ea,onFocus:()=>es("scope"),onBlur:()=>ei("scope"),required:!0,className:"form-input ".concat(J.scope?"form-input-error":""),children:[(0,s.jsx)("option",{value:"",children:g("stage1.selectScope")}),null==(l=p.find(e=>"scope"===e.key))||null==(a=l.validation)||null==(t=a.enumOptions)?void 0:t.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),$.scope&&(0,s.jsx)("div",{className:"form-tooltip",children:er("scope")}),J.scope&&(0,s.jsx)("div",{className:"form-error-message",children:J.scope})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"category",children:g("stage1.formLabels.category")}),(0,s.jsx)("input",{type:"text",id:"category",name:"category",value:S.category,onChange:ea,onFocus:()=>es("category"),onBlur:()=>ei("category"),required:!0,className:"form-input ".concat(J.category?"form-input-error":"")}),$.category&&(0,s.jsx)("div",{className:"form-tooltip",children:er("category")}),J.category&&(0,s.jsx)("div",{className:"form-error-message",children:J.category})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"location",children:g("stage1.formLabels.location")}),(0,s.jsx)("input",{type:"text",id:"location",name:"location",value:S.location,onChange:ea,onFocus:()=>es("location"),onBlur:()=>ei("location"),required:!0,className:"form-input ".concat(J.location?"form-input-error":"")}),$.location&&(0,s.jsx)("div",{className:"form-tooltip",children:er("location")}),J.location&&(0,s.jsx)("div",{className:"form-error-message",children:J.location})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"unit",children:g("stage1.formLabels.unit")}),(0,s.jsx)("input",{type:"text",id:"unit",name:"unit",value:S.unit,onChange:ea,onFocus:()=>es("unit"),onBlur:()=>ei("unit"),required:!0,className:"form-input ".concat(J.unit?"form-input-error":"")}),$.unit&&(0,s.jsx)("div",{className:"form-tooltip",children:er("unit")}),J.unit&&(0,s.jsx)("div",{className:"form-error-message",children:J.unit})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"dataSource",children:g("stage1.formLabels.dataSource")}),(0,s.jsx)("input",{type:"text",id:"dataSource",name:"dataSource",value:S.dataSource,onChange:ea,onFocus:()=>es("dataSource"),onBlur:()=>ei("dataSource"),required:!0,className:"form-input ".concat(J.dataSource?"form-input-error":"")}),$.dataSource&&(0,s.jsx)("div",{className:"form-tooltip",children:er("dataSource")}),J.dataSource&&(0,s.jsx)("div",{className:"form-error-message",children:J.dataSource})]})]})]}),(0,s.jsxs)("div",{className:"form-section",children:[(0,s.jsx)("h3",{className:"section-title",children:g("stage1.calculationMethodsTitle")}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"methodType",children:g("stage1.formLabels.methodType")}),(0,s.jsxs)("select",{id:"methodType",name:"methodType",value:S.methodType,onChange:ea,onFocus:()=>es("methodType"),onBlur:()=>ei("methodType"),required:!0,className:"form-input ".concat(J.methodType?"form-input-error":""),children:[(0,s.jsx)("option",{value:"",children:g("stage1.selectMethodType")}),null==(m=p.find(e=>"methodType"===e.key))||null==(d=m.validation)||null==(c=d.enumOptions)?void 0:c.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),$.methodType&&(0,s.jsx)("div",{className:"form-tooltip",children:er("methodType")}),J.methodType&&(0,s.jsx)("div",{className:"form-error-message",children:J.methodType})]})]}),(0,s.jsxs)("div",{className:"form-section",children:[(0,s.jsx)("h3",{className:"section-title",children:g("stage1.emissionFactorReferenceTitle")}),(0,s.jsxs)("div",{className:"form-grid",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"co2ePerUnit",children:g("stage1.formLabels.co2ePerUnit")}),(0,s.jsx)("input",{type:"number",id:"co2ePerUnit",name:"co2ePerUnit",value:S.co2ePerUnit,onChange:ea,onFocus:()=>es("co2ePerUnit"),onBlur:()=>ei("co2ePerUnit"),step:"0.01",required:!0,className:"form-input ".concat(J.co2ePerUnit?"form-input-error":"")}),$.co2ePerUnit&&(0,s.jsx)("div",{className:"form-tooltip",children:er("co2ePerUnit")}),J.co2ePerUnit&&(0,s.jsx)("div",{className:"form-error-message",children:J.co2ePerUnit})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"emissionFactorUnit",children:g("stage1.formLabels.emissionFactorUnit")}),(0,s.jsx)("input",{type:"text",id:"emissionFactorUnit",name:"emissionFactorUnit",value:S.emissionFactorUnit,onChange:ea,onFocus:()=>es("emissionFactorUnit"),onBlur:()=>ei("emissionFactorUnit"),required:!0,className:"form-input ".concat(J.emissionFactorUnit?"form-input-error":"")}),$.emissionFactorUnit&&(0,s.jsx)("div",{className:"form-tooltip",children:er("emissionFactorUnit")}),J.emissionFactorUnit&&(0,s.jsx)("div",{className:"form-error-message",children:J.emissionFactorUnit})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"ghgReportingStandard",children:g("stage1.formLabels.ghgReportingStandard")}),(0,s.jsxs)("select",{id:"ghgReportingStandard",name:"ghgReportingStandard",value:S.ghgReportingStandard,onChange:ea,onFocus:()=>es("ghgReportingStandard"),onBlur:()=>ei("ghgReportingStandard"),required:!0,className:"form-input ".concat(J.ghgReportingStandard?"form-input-error":""),children:[(0,s.jsx)("option",{value:"",children:g("stage1.selectStandard")}),z.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),$.ghgReportingStandard&&(0,s.jsx)("div",{className:"form-tooltip",children:er("ghgReportingStandard")}),J.ghgReportingStandard&&(0,s.jsx)("div",{className:"form-error-message",children:J.ghgReportingStandard})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"sourceOrDisclosureRequirement",children:g("stage1.formLabels.sourceOrDisclosureRequirement")}),(0,s.jsx)("input",{type:"text",id:"sourceOrDisclosureRequirement",name:"sourceOrDisclosureRequirement",value:S.sourceOrDisclosureRequirement,onChange:ea,onFocus:()=>es("sourceOrDisclosureRequirement"),onBlur:()=>ei("sourceOrDisclosureRequirement"),required:!0,className:"form-input ".concat(J.sourceOrDisclosureRequirement?"form-input-error":""),placeholder:g("stage1.placeholders.sourceOrDisclosureRequirement")}),$.sourceOrDisclosureRequirement&&(0,s.jsx)("div",{className:"form-tooltip",children:er("sourceOrDisclosureRequirement")}),J.sourceOrDisclosureRequirement&&(0,s.jsx)("div",{className:"form-error-message",children:J.sourceOrDisclosureRequirement})]})]})]}),(0,s.jsxs)("div",{className:"form-actions",children:[(0,s.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:C,children:C?g("stage1.saving"):k?g("stage1.update"):g("stage1.add")}),k&&(0,s.jsx)("button",{type:"button",onClick:()=>{F({description:"",scope:"",category:"",location:"",unit:"",dataSource:"",methodType:"Volume Based",co2ePerUnit:0,emissionFactorUnit:"",ghgReportingStandard:"",sourceOrDisclosureRequirement:""}),A(!1),Y({})},className:"btn btn-secondary",children:g("stage1.cancel")})]})]}),(0,s.jsxs)("div",{className:"data-section",ref:Z,children:[(0,s.jsx)("h3",{className:"section-title",children:g("stage1.savedEmissionFactorsTitle")}),E.length>0&&(0,s.jsx)(y,{data:E,selectedRows:_,onRowSelect:(e,t)=>{"string"==typeof e&&(t?G(t=>new Set([...t,e])):G(t=>{let a=new Set(t);return a.delete(e),a}))},onSelectAll:e=>{e?G(new Set(E.map(e=>e._id).filter(Boolean))):G(new Set)},onEdit:e=>{B(e),R(!0)},onDelete:e=>{P(e),O(!0)},onBulkDelete:()=>{if(0===_.size)return void r.toast.error(g("stage1.toast.selectAtLeastOneToDelete"));M(!0)},isDeleting:V,showBulkDelete:!0,tableType:"saved"}),0===E.length&&(0,s.jsx)("div",{className:"no-data",children:(0,s.jsx)("p",{children:g("stage1.noEmissionFactorsMessage")})})]}),(0,s.jsx)("div",{className:"stage-actions",children:(0,s.jsx)("button",{onClick:u,className:"btn btn-primary",children:g("stage1.nextButton")})}),(0,s.jsx)(f,{isOpen:w,onClose:()=>{R(!1),B(null)},factor:T,onUpdate:en,ghgStandards:z}),(0,s.jsx)(N,{isOpen:q,onClose:()=>{O(!1),P(null)},onConfirm:el,title:g("stage1.deleteEmissionFactorTitle"),message:g("stage1.deleteEmissionFactorMessage"),confirmText:g("stage1.delete"),cancelText:g("stage1.cancel")}),(0,s.jsx)(N,{isOpen:U,onClose:()=>M(!1),onConfirm:ec,title:g("stage1.bulkDeleteEmissionFactorsTitle"),message:g("stage1.bulkDeleteEmissionFactorsMessage"),confirmText:g("stage1.deleteAll"),cancelText:g("stage1.cancel"),isBulkDelete:!0,selectedCount:_.size})]})},F=e=>{let{isOpen:t,onClose:a,activity:l,onUpdate:c,emissionFactors:d}=e,m=(0,o.c3)(),{locale:u}=(0,n.s)(),[g,h]=(0,i.useState)(0),[p,f]=(0,i.useState)({reportingPeriodStart:"",reportingPeriodEnd:"",scope:"",category:"",activityName:"",location:"",quantity:0,emissionFactorId:"",remarks:""}),[y,x]=(0,i.useState)([]),[b,j]=(0,i.useState)(!1),[N,S]=(0,i.useState)({});(0,i.useEffect)(()=>{h(e=>e+1)},[u]),(0,i.useEffect)(()=>{if(l&&(console.log("EditActivityModal: Initializing form with activity:",l),console.log("EditActivityModal: Activity emissionFactorId:",l.emissionFactorId,"type:",typeof l.emissionFactorId),console.log("EditActivityModal: Available emission factors:",d),f(l),F(l.scope,l.location,l.category),S({}),l.emissionFactorId)){let e=d.find(e=>String(e._id)===String(l.emissionFactorId));console.log("EditActivityModal: Found emission factor for activity:",e),e||console.warn("EditActivityModal: WARNING - Activity has emission factor ID that does not exist:",l.emissionFactorId)}},[l,d]),(0,i.useEffect)(()=>{if(Object.keys(N).length>0){let e={};Object.keys(N).forEach(t=>{let a=p[t];if(void 0!==a){let s=E(t,a);s&&(e[t]=s)}}),S(e)}},[u,m]),(0,i.useEffect)(()=>{F(p.scope,p.location,p.category)},[p.scope,p.location,p.category,d]);let F=(e,t,a)=>{console.log("EditActivityModal: updateFilteredEmissionFactors called with:",{scope:e,location:t,category:a}),console.log("EditActivityModal: Total emission factors available:",d.length);let s=d;e&&console.log("EditActivityModal: After scope filter:",(s=s.filter(t=>t.scope===e)).length),t&&console.log("EditActivityModal: After location filter:",(s=s.filter(e=>e.location===t)).length),a&&console.log("EditActivityModal: After category filter:",(s=s.filter(e=>e.category===a)).length),console.log("EditActivityModal: Final filtered emission factors:",s),x(s),p.emissionFactorId&&e&&t&&a&&!s.find(e=>String(e._id)===String(p.emissionFactorId))&&(console.log("EditActivityModal: Resetting emission factor because it's not in filtered list"),f(e=>({...e,emissionFactorId:""})))},E=(e,t)=>{switch(e){case"reportingPeriodStart":if(!t||""===t.trim())return m("stage2.validation.startDateRequired");return"";case"reportingPeriodEnd":if(!t||""===t.trim())return m("stage2.validation.endDateRequired");if(p.reportingPeriodStart&&new Date(t)<=new Date(p.reportingPeriodStart))return m("stage2.validation.endDateAfterStart");return"";case"scope":if(!t||""===t.trim())return m("stage2.validation.scopeRequired");return"";case"category":if(!t||""===t.trim())return m("stage2.validation.categoryRequired");return"";case"activityName":if(!t||""===t.trim())return m("stage2.validation.activityNameRequired");return"";case"location":if(!t||""===t.trim())return m("stage2.validation.locationRequired");return"";case"quantity":if(null==t||""===t||isNaN(Number(t))||0>=Number(t))return m("stage2.validation.quantityPositive");return"";case"emissionFactorId":if(!t||""===t.trim())return m("stage2.validation.emissionFactorRequired");return"";default:return""}},D=e=>{let{name:t,value:a}=e.target;if(console.log("EditActivityModal: Input change - name: ".concat(t,", value: ").concat(a,", type: ").concat(typeof a)),"location"===t||"category"===t)f(e=>({...e,[t]:a,emissionFactorId:""}));else if("emissionFactorId"===t){console.log("EditActivityModal: Selected emission factor ID: ".concat(a)),console.log("EditActivityModal: Available emission factors:",d),console.log("EditActivityModal: Filtered emission factors:",y);let e=""===a?"":String(a);console.log("EditActivityModal: Processed emission factor ID: ".concat(e));let t=d.find(t=>String(t._id)===e);console.log("EditActivityModal: Selected factor found:",t),t||""===e||(console.error("EditActivityModal: ERROR - Emission factor with ID ".concat(e," not found!")),console.error("EditActivityModal: Available IDs:",d.map(e=>({id:e._id,type:typeof e._id}))),console.error("EditActivityModal: Looking for string ID: ".concat(e))),f(t=>({...t,emissionFactorId:e}))}else f(e=>({...e,[t]:"quantity"===t?parseFloat(a)||0:a}));N[t]&&S(e=>({...e,[t]:""}))},k=e=>{let t=p[e],a=E(e,t);S(t=>({...t,[e]:a}))},A=()=>{let e={};return console.log("Validating fields with form data:",p),["reportingPeriodStart","reportingPeriodEnd","scope","category","activityName","location","quantity","emissionFactorId"].forEach(t=>{let a=E(t,p[t]);a&&(e[t]=a,console.log("Field ".concat(t," has error:"),a))}),p.emissionFactorId&&!e.emissionFactorId&&(d.find(e=>String(e._id)===String(p.emissionFactorId))||(e.emissionFactorId="Selected emission factor not found. Please select a valid emission factor.",console.error("EditActivityModal: Validation error - emission factor not found:",p.emissionFactorId))),console.log("Validation errors:",e),S(e),0===Object.keys(e).length},C=async e=>{if(e.preventDefault(),!A())return void r.toast.error("Please correct the errors before updating");j(!0);try{console.log("EditActivityModal: Submitting updated activity:",p),console.log("EditActivityModal: Activity ID being updated:",p._id),console.log("EditActivityModal: Activity ID type:",typeof p._id),console.log("EditActivityModal: Emission factor ID:",p.emissionFactorId),console.log("EditActivityModal: Emission factor ID type:",typeof p.emissionFactorId),console.log("EditActivityModal: Quantity:",p.quantity);let e=d.find(e=>String(e._id)===String(p.emissionFactorId));if(console.log("EditActivityModal: Found emission factor for calculation:",e),!e){console.error("EditActivityModal: ERROR - Selected emission factor not found!"),console.error("EditActivityModal: Selected ID:",p.emissionFactorId),console.error("EditActivityModal: Available emission factors:",d),console.error("EditActivityModal: Looking for string ID:",String(p.emissionFactorId)),r.toast.error("Selected emission factor not found. Please select a valid emission factor.");return}let t={description:e.description,co2ePerUnit:e.co2ePerUnit,emissionFactorUnit:e.emissionFactorUnit,unit:e.unit},s=p.quantity*e.co2ePerUnit;console.log("EditActivityModal: Calculated emissions:",s);let i={...p,calculatedEmissions:s,emissionFactorData:t};await v.updateReportingActivity(i),console.log("EditActivityModal: Activity updated successfully"),await c(i),setTimeout(()=>{a(),r.toast.success(m("stage2.toast.updatedSuccessfully"))},100)}catch(e){console.error("EditActivityModal: Error updating activity:",e),r.toast.error(e instanceof Error?e.message:m("stage2.toast.updateFailed"))}finally{j(!1)}};return t&&l?(0,s.jsx)("div",{className:"modal-overlay",onClick:a,children:(0,s.jsxs)("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[(0,s.jsx)("div",{className:"modal-header",children:(0,s.jsx)("h3",{className:"modal-title",children:m("stage2.editActivity.title")})}),(0,s.jsxs)("form",{onSubmit:C,className:"modal-body",children:[(0,s.jsxs)("div",{className:"form-section",children:[(0,s.jsx)("h4",{className:"section-title",children:m("stage2.editActivity.activityInformation")}),(0,s.jsxs)("div",{className:"form-grid",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-activityName",children:[m("stage2.formLabels.activityName")," *"]}),(0,s.jsx)("input",{type:"text",id:"modal-activityName",name:"activityName",value:p.activityName,onChange:D,onBlur:()=>k("activityName"),required:!0,className:"form-input ".concat(N.activityName?"form-input-error":""),placeholder:"e.g., Office Electricity Consumption"}),N.activityName&&(0,s.jsx)("div",{className:"form-error-message",children:N.activityName})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-reportingPeriodStart",children:[m("stage2.formLabels.reportingPeriodStart")," *"]}),(0,s.jsx)("input",{type:"date",id:"modal-reportingPeriodStart",name:"reportingPeriodStart",value:p.reportingPeriodStart,onChange:D,onBlur:()=>k("reportingPeriodStart"),required:!0,className:"form-input ".concat(N.reportingPeriodStart?"form-input-error":"")}),N.reportingPeriodStart&&(0,s.jsx)("div",{className:"form-error-message",children:N.reportingPeriodStart})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-reportingPeriodEnd",children:[m("stage2.formLabels.reportingPeriodEnd")," *"]}),(0,s.jsx)("input",{type:"date",id:"modal-reportingPeriodEnd",name:"reportingPeriodEnd",value:p.reportingPeriodEnd,onChange:D,onBlur:()=>k("reportingPeriodEnd"),required:!0,className:"form-input ".concat(N.reportingPeriodEnd?"form-input-error":"")}),N.reportingPeriodEnd&&(0,s.jsx)("div",{className:"form-error-message",children:N.reportingPeriodEnd})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-scope",children:[m("stage2.formLabels.scope")," *"]}),(0,s.jsxs)("select",{id:"modal-scope",name:"scope",value:p.scope,onChange:D,onBlur:()=>k("scope"),required:!0,className:"form-input ".concat(N.scope?"form-input-error":""),children:[(0,s.jsx)("option",{value:"",children:m("stage1.selectScope")}),(0,s.jsx)("option",{value:"Scope 1",children:"Scope 1"}),(0,s.jsx)("option",{value:"Scope 2",children:"Scope 2"}),(0,s.jsx)("option",{value:"Scope 3",children:"Scope 3"})]}),N.scope&&(0,s.jsx)("div",{className:"form-error-message",children:N.scope})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-category",children:[m("stage2.formLabels.category")," *"]}),(0,s.jsxs)("select",{id:"modal-category",name:"category",value:p.category,onChange:D,onBlur:()=>k("category"),required:!0,className:"form-input ".concat(N.category?"form-input-error":""),children:[(0,s.jsx)("option",{value:"",children:m("stage1.selectCategory")}),Array.from(new Set(d.map(e=>e.category).filter(Boolean))).sort().map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),N.category&&(0,s.jsx)("div",{className:"form-error-message",children:N.category})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-location",children:[m("stage2.formLabels.location")," *"]}),(0,s.jsxs)("select",{id:"modal-location",name:"location",value:p.location,onChange:D,onBlur:()=>k("location"),required:!0,className:"form-input ".concat(N.location?"form-input-error":""),children:[(0,s.jsx)("option",{value:"",children:m("stage1.selectLocation")}),Array.from(new Set(d.map(e=>e.location).filter(Boolean))).sort().map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),N.location&&(0,s.jsx)("div",{className:"form-error-message",children:N.location})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-quantity",children:[m("stage2.formLabels.quantity")," *"]}),(0,s.jsx)("input",{type:"number",id:"modal-quantity",name:"quantity",value:p.quantity,onChange:D,onBlur:()=>k("quantity"),step:"0.01",required:!0,className:"form-input ".concat(N.quantity?"form-input-error":""),placeholder:"e.g., 1000"}),N.quantity&&(0,s.jsx)("div",{className:"form-error-message",children:N.quantity})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"modal-emissionFactorId",children:[m("stage2.formLabels.emissionFactorId")," *"]}),(0,s.jsxs)("select",{id:"modal-emissionFactorId",name:"emissionFactorId",value:p.emissionFactorId,onChange:D,onBlur:()=>k("emissionFactorId"),required:!0,className:"form-input ".concat(N.emissionFactorId?"form-input-error":""),disabled:!p.scope||!p.location||!p.category,children:[(0,s.jsx)("option",{value:"",children:m("stage1.selectEmissionFactor")}),y.map(e=>{let t=String(e._id)===String(p.emissionFactorId);return console.log("EditActivityModal: Rendering option for factor:",e),console.log("EditActivityModal: Factor ID: ".concat(e._id,", type: ").concat(typeof e._id)),console.log("EditActivityModal: Form emissionFactorId: ".concat(p.emissionFactorId,", type: ").concat(typeof p.emissionFactorId)),console.log("EditActivityModal: Is selected: ".concat(t)),(0,s.jsxs)("option",{value:e._id,children:[e.description," (",e.co2ePerUnit," ",e.emissionFactorUnit,")"]},e._id)})]}),(!p.scope||!p.location||!p.category)&&(0,s.jsx)("small",{className:"form-help",children:m("stage2.editActivity.selectScopeLocationCategory")}),N.emissionFactorId&&(0,s.jsx)("div",{className:"form-error-message",children:N.emissionFactorId}),p.emissionFactorId&&(0,s.jsxs)("small",{className:"form-help",children:[m("stage2.editActivity.selected"),": ",(()=>{let e=d.find(e=>String(e._id)===String(p.emissionFactorId));return e?"".concat(e.description," (ID: ").concat(e._id,")"):m("stage2.editActivity.emissionFactorNotFound")})()]})]})]})]}),(0,s.jsxs)("div",{className:"form-section",children:[(0,s.jsx)("h4",{className:"section-title",children:m("stage2.editActivity.additionalInformation")}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"modal-remarks",children:m("stage2.formLabels.remarks")}),(0,s.jsx)("textarea",{id:"modal-remarks",name:"remarks",value:p.remarks||"",onChange:D,className:"form-input",rows:3,placeholder:"Additional notes or comments..."})]})]}),(0,s.jsxs)("div",{className:"modal-actions",children:[(0,s.jsx)("button",{type:"button",onClick:a,className:"btn btn-secondary modal-btn",disabled:b,children:m("common.cancel")}),(0,s.jsx)("button",{type:"submit",className:"btn btn-primary modal-btn",disabled:b,children:b?m("stage2.updating"):m("stage2.update")})]})]})]})}):null},E=r.default||r,D=e=>{let{onNext:t}=e,a=(0,o.c3)(),[r,n]=(0,i.useState)({reportingPeriodStart:"",reportingPeriodEnd:"",scope:"",category:"",activityName:"",location:"",quantity:0,emissionFactorId:"",remarks:""}),[l,c]=(0,i.useState)([]),[d,m]=(0,i.useState)([]),[g,h]=(0,i.useState)([]),[p,f]=(0,i.useState)(!1),[y,x]=(0,i.useState)(!0),[b,j]=(0,i.useState)("connected"),[S,D]=(0,i.useState)(!1),[k,A]=(0,i.useState)(null),[C,I]=(0,i.useState)(!1),[w,R]=(0,i.useState)(null),[T,B]=(0,i.useState)(!1),[q,O]=(0,i.useState)([]),[L,P]=(0,i.useState)([]);(0,i.useEffect)(()=>{(async()=>{try{x(!0);let e=await v.getAllEmissionFactors();m(Array.isArray(e)?e:[]);let t=await v.getAllReportingActivities(),a=Array.isArray(t)?t:[];c(a),j("connected")}catch(e){console.error("Error loading data:",e),j("error"),E.error(a("stage2.toast.loadDataFailed")),m([]),c([])}finally{x(!1)}})()},[]),(0,i.useEffect)(()=>{if(d.length>0&&l.length>0){let e=l.map(e=>{if(void 0===e.calculatedEmissions||null===e.calculatedEmissions){let t=d.find(t=>String(t._id)===String(e.emissionFactorId));if(t&&e.quantity){let a=e.quantity*t.co2ePerUnit;return{...e,calculatedEmissions:a}}}return e});JSON.stringify(e)!==JSON.stringify(l)&&(c(e),e.forEach(async e=>{if(void 0!==e.calculatedEmissions&&null!==e.calculatedEmissions)try{await v.updateReportingActivity(e)}catch(t){console.error("Failed to update calculated emissions for activity:",e._id,t)}}))}},[d,l.length]),(0,i.useEffect)(()=>{if(d.length>0){let e=[...new Set(d.map(e=>e.location).filter(Boolean))].sort(),t=[...new Set(d.map(e=>e.category).filter(Boolean))].sort();O(e),P(t)}},[d]),(0,i.useEffect)(()=>{let e=d;r.scope&&(e=e.filter(e=>e.scope===r.scope)),r.location&&(e=e.filter(e=>e.location===r.location)),r.category&&(e=e.filter(e=>e.category===r.category)),h(e),r.emissionFactorId&&r.scope&&r.location&&r.category&&!e.find(e=>String(e._id)===String(r.emissionFactorId))&&n(e=>({...e,emissionFactorId:""}))},[r.scope,r.location,r.category,d]),(0,i.useEffect)(()=>{r.location&&!q.includes(r.location)&&n(e=>({...e,location:"",emissionFactorId:""}))},[q]),(0,i.useEffect)(()=>{r.category&&!L.includes(r.category)&&n(e=>({...e,category:"",emissionFactorId:""}))},[L]);let U=e=>{let{name:t,value:a}=e.target;"location"===t||"category"===t?n(e=>({...e,[t]:a,emissionFactorId:""})):"emissionFactorId"===t?n(e=>({...e,emissionFactorId:a})):n(e=>({...e,[t]:"quantity"===t?parseFloat(a)||0:a}))},M=async e=>{e.preventDefault(),f(!0);try{if(!r.emissionFactorId)return void E.error(a("stage2.validation.emissionFactorRequired"));let e=null,t=String(r.emissionFactorId);if(!(e=d.find(e=>String(e._id)===t)))return void E.error(a("stage2.validation.emissionFactorNotFound"));let s={description:e.description,co2ePerUnit:e.co2ePerUnit,emissionFactorUnit:e.emissionFactorUnit,unit:e.unit},i=r.quantity*e.co2ePerUnit,o={...r,calculatedEmissions:i,emissionFactorData:s};await v.addReportingActivity(o),E.success(a("stage2.toast.savedSuccessfully")),W(),await K()}catch(e){console.error("Error saving activity:",e),E.error(a("stage2.toast.saveFailed"))}finally{f(!1)}},_=e=>{A(e),D(!0)},G=e=>{R(e),I(!0)},V=async()=>{if(w&&w._id){B(!0);try{await v.deleteReportingActivity(w._id),E.success(a("stage2.toast.deletedSuccessfully")),I(!1),R(null),await K()}catch(e){console.error("Error deleting activity:",e),E.error(a("stage2.toast.deleteFailed"))}finally{B(!1)}}},W=()=>{n({reportingPeriodStart:"",reportingPeriodEnd:"",scope:"",category:"",activityName:"",location:"",quantity:0,emissionFactorId:"",remarks:""})},z=async e=>{try{if(!e._id)throw Error("Activity ID is missing");if(e.emissionFactorData){let t=e.quantity*e.emissionFactorData.co2ePerUnit,a={...e,calculatedEmissions:t};await v.updateReportingActivity(a)}else{let t=d.find(t=>String(t._id)===String(e.emissionFactorId)),a=t?e.quantity*t.co2ePerUnit:0,s={...e,calculatedEmissions:a};await v.updateReportingActivity(s)}await K()}catch(e){throw console.error("Error updating activity:",e),e}},H=(e,t)=>{if(null==t?void 0:t.emissionFactorData)return"".concat(t.emissionFactorData.description," (").concat(t.emissionFactorData.co2ePerUnit," ").concat(t.emissionFactorData.emissionFactorUnit,")");if(!e)return"No emission factor selected";let a=d.find(t=>String(t._id)===String(e));return a?"".concat(a.description," (").concat(a.co2ePerUnit," ").concat(a.emissionFactorUnit,")"):"⚠️ Emission factor not found (ID: "+e+")"},J=e=>{if(void 0!==e.calculatedEmissions&&null!==e.calculatedEmissions)return e.calculatedEmissions;if(e.emissionFactorData)return e.quantity*e.emissionFactorData.co2ePerUnit;if(e.emissionFactorId){let t=d.find(t=>String(t._id)===String(e.emissionFactorId));if(t&&e.quantity)return e.quantity*t.co2ePerUnit}return null},Y=e=>{if(!e)return"";let t=d.find(t=>String(t._id)===String(e));return t?t.emissionFactorUnit:""},$=async e=>{try{let t={description:"Auto-generated for ".concat(e.activityName),scope:e.scope,category:e.category,location:e.location,unit:"kWh",dataSource:"Auto-generated",methodType:"Volume Based",co2ePerUnit:.5,emissionFactorUnit:"kg CO2e/kWh",ghgReportingStandard:"GHG Protocol",sourceOrDisclosureRequirement:"Auto-generated - please update with actual values"},s=await v.addEmissionFactor(t),i={...e,emissionFactorId:s,calculatedEmissions:e.quantity*t.co2ePerUnit};await v.updateReportingActivity(i),E.success(a("stage2.toast.createdMissingEmissionFactorSuccessfully")),await K()}catch(e){console.error("Error creating missing emission factor:",e),E.error(a("stage2.toast.createMissingEmissionFactorFailed"))}},K=async()=>{try{x(!0);let e=await v.getAllEmissionFactors();m(Array.isArray(e)?e:[]);let t=await v.getAllReportingActivities(),a=Array.isArray(t)?t:[];c(a)}catch(e){console.error("Error refreshing data:",e),E.error(a("stage2.toast.refreshDataFailed"))}finally{x(!1)}};return(0,s.jsxs)("div",{className:"stage",children:[(0,s.jsx)("h2",{className:"stage-title",children:a("stage2.title")}),(0,s.jsxs)("form",{onSubmit:M,className:"activity-form",children:[(0,s.jsxs)("div",{className:"form-grid",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"reportingPeriodStart",children:[a("stage2.formLabels.reportingPeriodStart")," *"]}),(0,s.jsx)("input",{type:"date",id:"reportingPeriodStart",name:"reportingPeriodStart",value:r.reportingPeriodStart,onChange:U,required:!0,className:"form-input"})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"reportingPeriodEnd",children:[a("stage2.formLabels.reportingPeriodEnd")," *"]}),(0,s.jsx)("input",{type:"date",id:"reportingPeriodEnd",name:"reportingPeriodEnd",value:r.reportingPeriodEnd,onChange:U,required:!0,className:"form-input"})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"scope",children:[a("stage2.formLabels.scope")," *"]}),(0,s.jsxs)("select",{id:"scope",name:"scope",value:r.scope,onChange:U,required:!0,className:"form-input",children:[(0,s.jsx)("option",{value:"",children:a("stage2.placeholders.scope")}),(0,s.jsx)("option",{value:"Scope 1",children:"Scope 1"}),(0,s.jsx)("option",{value:"Scope 2",children:"Scope 2"}),(0,s.jsx)("option",{value:"Scope 3",children:"Scope 3"})]})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"category",children:[a("stage2.formLabels.category")," *"]}),(0,s.jsxs)("select",{id:"category",name:"category",value:r.category,onChange:U,required:!0,className:"form-input",children:[(0,s.jsx)("option",{value:"",children:a("stage2.placeholders.category")}),L.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"activityName",children:[a("stage2.formLabels.activityName")," *"]}),(0,s.jsx)("input",{type:"text",id:"activityName",name:"activityName",value:r.activityName,onChange:U,required:!0,className:"form-input",placeholder:a("stage2.placeholders.activityName")})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"location",children:[a("stage2.formLabels.location")," *"]}),(0,s.jsxs)("select",{id:"location",name:"location",value:r.location,onChange:U,required:!0,className:"form-input",children:[(0,s.jsx)("option",{value:"",children:a("stage2.placeholders.location")}),q.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"quantity",children:[a("stage2.formLabels.quantity")," *"]}),(0,s.jsx)("input",{type:"number",id:"quantity",name:"quantity",value:r.quantity,onChange:U,step:"0.01",required:!0,className:"form-input",placeholder:a("stage2.placeholders.quantity")})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"emissionFactorId",children:[a("stage2.formLabels.emissionFactorId")," *"]}),(0,s.jsxs)("select",{id:"emissionFactorId",name:"emissionFactorId",value:r.emissionFactorId,onChange:U,required:!0,className:"form-input",disabled:!r.scope||!r.location||!r.category,children:[(0,s.jsx)("option",{value:"",children:a("stage2.placeholders.emissionFactorId")}),g.map(e=>(0,s.jsxs)("option",{value:e._id,children:[e.description," (",e.co2ePerUnit," ",e.emissionFactorUnit,")"]},e._id))]}),(!r.scope||!r.location||!r.category)&&(0,s.jsx)("small",{className:"form-help",children:a("stage2.validation.selectScopeLocationCategory")})]})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"remarks",children:a("stage2.formLabels.remarks")}),(0,s.jsx)("textarea",{id:"remarks",name:"remarks",value:r.remarks,onChange:U,className:"form-input",rows:3,placeholder:a("stage2.placeholders.remarks")})]}),(0,s.jsx)("div",{className:"form-actions",children:(0,s.jsx)("button",{type:"submit",className:"btn btn-primary",disabled:p,children:p?a("stage2.saving"):a("stage2.save")})})]}),(0,s.jsxs)("div",{className:"data-section",children:[(0,s.jsxs)("h3",{className:"section-title",children:[a("stage2.savedActivities"),"fallback"===b&&(0,s.jsxs)("span",{className:"connection-status fallback",children:["\uD83D\uDCF1 ",a("stage2.connectionStatus.fallback")]}),"error"===b&&(0,s.jsxs)("span",{className:"connection-status error",children:["⚠️ ",a("stage2.connectionStatus.error")]})]}),y?(0,s.jsx)("div",{className:"loading-state",children:(0,s.jsx)("p",{children:a("common.loading")})}):(0,s.jsx)("div",{className:"table-container",children:Array.isArray(l)&&l.length>0?(0,s.jsxs)("table",{className:"data-table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:a("stage2.formLabels.activityName")}),(0,s.jsx)("th",{children:a("stage2.formLabels.reportingPeriod")}),(0,s.jsx)("th",{children:a("stage2.formLabels.scope")}),(0,s.jsx)("th",{children:a("stage2.formLabels.category")}),(0,s.jsx)("th",{children:a("stage2.formLabels.location")}),(0,s.jsx)("th",{children:a("stage2.formLabels.quantity")}),(0,s.jsx)("th",{children:a("stage2.formLabels.emissionFactorId")}),(0,s.jsx)("th",{children:a("stage2.formLabels.calculatedEmissions")}),(0,s.jsx)("th",{children:a("stage2.formLabels.remarks")}),(0,s.jsx)("th",{children:a("common.actions")})]})}),(0,s.jsx)("tbody",{children:l.map(e=>{let t=J(e);Y(e.emissionFactorId);let i=d.some(t=>String(t._id)===String(e.emissionFactorId));return(0,s.jsxs)("tr",{style:i?{}:{backgroundColor:"#fff3cd"},children:[(0,s.jsx)("td",{children:e.activityName}),(0,s.jsxs)("td",{children:[e.reportingPeriodStart," ",a("stage2.dateRangeSeparator")," ",e.reportingPeriodEnd]}),(0,s.jsx)("td",{children:e.scope}),(0,s.jsx)("td",{children:e.category}),(0,s.jsx)("td",{children:e.location}),(0,s.jsx)("td",{children:e.quantity}),(0,s.jsx)("td",{children:e.emissionFactorData?"".concat(e.emissionFactorData.description," (").concat(e.emissionFactorData.co2ePerUnit," ").concat(e.emissionFactorData.emissionFactorUnit,")"):i?H(e.emissionFactorId,e):(0,s.jsxs)("span",{style:{color:"#dc3545",fontWeight:"bold"},children:["⚠️ Emission factor not found (ID: ",e.emissionFactorId,")"]})}),(0,s.jsx)("td",{children:(()=>{if(null!==t){var r;let s=(null==(r=e.emissionFactorData)?void 0:r.emissionFactorUnit)||Y(e.emissionFactorId);return"".concat(t.toFixed(2)," ").concat(s||a("stage2.defaultUnit"))}return i||e.emissionFactorData?a("common.noData"):(0,s.jsx)("span",{style:{color:"#dc3545"},children:a("stage2.cannotCalculateEFMissing")})})()}),(0,s.jsx)("td",{children:e.remarks||a("common.noData")}),(0,s.jsx)("td",{children:(0,s.jsxs)("div",{className:"action-buttons",children:[(0,s.jsxs)("button",{onClick:()=>_(e),className:"btn btn-small btn-secondary",title:a("common.edit"),children:[(0,s.jsx)(u.uO9,{})," ",a("common.edit")]}),(0,s.jsxs)("button",{onClick:()=>G(e),className:"btn btn-small btn-danger",title:a("common.delete"),disabled:T,children:[(0,s.jsx)(u.qbC,{})," ",a("common.delete")]}),!i&&(0,s.jsx)("button",{onClick:()=>$(e),className:"btn btn-small btn-primary",style:{fontSize:"10px",padding:"2px 4px"},title:a("stage2.createMissingEmissionFactor"),children:a("stage2.createMissingEmissionFactor")})]})})]},e._id)})})]}):(0,s.jsxs)("div",{className:"no-data",children:[(0,s.jsx)("p",{children:a("stage2.noActivitiesMessage")}),"fallback"===b&&(0,s.jsx)("p",{className:"fallback-note",children:(0,s.jsx)("small",{children:a("stage2.connectionStatus.fallback")})})]})})]}),(0,s.jsx)("div",{className:"stage-actions",children:(0,s.jsx)("button",{onClick:t,className:"btn btn-primary",children:a("stage2.nextButton")})}),(0,s.jsx)(F,{isOpen:S,onClose:()=>{D(!1),A(null)},activity:k,onUpdate:z,emissionFactors:d}),(0,s.jsx)(N,{isOpen:C,onClose:()=>{I(!1),R(null)},onConfirm:V,title:a("stage2.deleteModal.title"),message:a("stage2.deleteModal.message",{activityName:(null==w?void 0:w.activityName)||""}),confirmText:a("stage2.deleteModal.confirmText"),cancelText:a("stage2.deleteModal.cancelText")})]})};var k=a(2502);let A=e=>{var t,a,n;let{chartConfig:l,onSave:c,onCancel:d}=e,m=(0,o.c3)(),[u,g]=(0,i.useState)({id:"",title:"",chartType:"bar",xAxis:"",yAxis:"",aggregation:"sum",xAxisLabel:"",yAxisLabel:"",colors:["#2E7D32","#4CAF50","#8BC34A","#CDDC39"],description:""}),[h,p]=(0,i.useState)([]),[f,y]=(0,i.useState)([]),x=(0,i.useMemo)(()=>[{key:"activityName",label:m("stage2.formLabels.activityName"),type:"string",chartCompatible:!0,description:m("stage3.chartBuilder.fieldDescriptions.activityName")},{key:"reportingPeriodStart",label:m("stage2.formLabels.reportingPeriodStart"),type:"date",chartCompatible:!0,description:m("stage3.chartBuilder.fieldDescriptions.reportingPeriodStart")},{key:"reportingPeriodEnd",label:m("stage2.formLabels.reportingPeriodEnd"),type:"date",chartCompatible:!0,description:m("stage3.chartBuilder.fieldDescriptions.reportingPeriodEnd")},{key:"scope",label:m("stage2.formLabels.scope"),type:"string",chartCompatible:!0,description:m("stage3.chartBuilder.fieldDescriptions.scope")},{key:"category",label:m("stage2.formLabels.category"),type:"string",chartCompatible:!0,description:m("stage3.chartBuilder.fieldDescriptions.category")},{key:"location",label:m("stage2.formLabels.location"),type:"string",chartCompatible:!0,description:m("stage3.chartBuilder.fieldDescriptions.location")},{key:"quantity",label:m("stage2.formLabels.quantity"),type:"number",chartCompatible:!0,description:m("stage3.chartBuilder.fieldDescriptions.quantity")},{key:"emissionFactorId",label:m("stage2.formLabels.emissionFactorId"),type:"string",chartCompatible:!0,description:m("stage3.chartBuilder.fieldDescriptions.emissionFactorId")},{key:"calculatedEmissions",label:m("stage2.formLabels.calculatedEmissions"),type:"number",chartCompatible:!0,description:m("stage3.chartBuilder.fieldDescriptions.calculatedEmissions")}],[m]),v=(0,i.useMemo)(()=>[{value:"bar",label:m("stage3.chartBuilder.chartTypes.bar"),description:m("stage3.chartBuilder.chartTypeDescriptions.bar")},{value:"line",label:m("stage3.chartBuilder.chartTypes.line"),description:m("stage3.chartBuilder.chartTypeDescriptions.line")},{value:"pie",label:m("stage3.chartBuilder.chartTypes.pie"),description:m("stage3.chartBuilder.chartTypeDescriptions.pie")},{value:"donut",label:m("stage3.chartBuilder.chartTypes.donut"),description:m("stage3.chartBuilder.chartTypeDescriptions.donut")}],[m]),b=(0,i.useMemo)(()=>[{value:"sum",label:m("stage3.chartBuilder.aggregationTypes.sum"),description:m("stage3.chartBuilder.aggregationTypeDescriptions.sum")},{value:"average",label:m("stage3.chartBuilder.aggregationTypes.average"),description:m("stage3.chartBuilder.aggregationTypeDescriptions.average")},{value:"count",label:m("stage3.chartBuilder.aggregationTypes.count"),description:m("stage3.chartBuilder.aggregationTypeDescriptions.count")},{value:"min",label:m("stage3.chartBuilder.aggregationTypes.min"),description:m("stage3.chartBuilder.aggregationTypeDescriptions.min")},{value:"max",label:m("stage3.chartBuilder.aggregationTypes.max"),description:m("stage3.chartBuilder.aggregationTypeDescriptions.max")}],[m]),j=(0,i.useMemo)(()=>[["#2E7D32","#4CAF50","#8BC34A","#CDDC39"],["#FF9800","#FF5722","#9C27B0","#3F51B5"],["#2196F3","#03A9F4","#00BCD4","#009688"],["#795548","#9E9E9E","#607D8B","#FFC107"]],[]),N=(0,i.useCallback)(()=>{let e=[];u.title.trim()||e.push({field:"title",message:m("stage3.chartBuilder.validation.chartTitleRequired"),severity:"error"}),u.xAxis||e.push({field:"xAxis",message:m("stage3.chartBuilder.validation.xAxisRequired"),severity:"error"}),u.yAxis||e.push({field:"yAxis",message:m("stage3.chartBuilder.validation.yAxisRequired"),severity:"error"}),u.xAxis===u.yAxis&&e.push({field:"yAxis",message:m("stage3.chartBuilder.validation.axesMustBeDifferent"),severity:"error"});let t=x.find(e=>e.key===u.xAxis),a=x.find(e=>e.key===u.yAxis);("pie"===u.chartType||"donut"===u.chartType)&&((null==t?void 0:t.type)==="number"||(null==a?void 0:a.type)==="date")&&e.push({field:"chartType",message:m("stage3.chartBuilder.validation.pieDonutCategoricalWarning"),severity:"warning"}),"line"===u.chartType&&(null==t?void 0:t.type)!=="date"&&(null==t?void 0:t.type)!=="string"&&e.push({field:"xAxis",message:m("stage3.chartBuilder.validation.lineChartWarning"),severity:"warning"}),p(e)},[u,x]),S=(0,i.useCallback)(()=>{let e=[];("scope"!==u.xAxis||"calculatedEmissions"!==u.yAxis)&&e.push({title:m("stage3.chartBuilder.suggestions.emissionsByScope.title"),description:m("stage3.chartBuilder.suggestions.emissionsByScope.description"),chartType:"bar",xAxis:"scope",yAxis:"calculatedEmissions",aggregation:"sum",reason:m("stage3.chartBuilder.suggestions.emissionsByScope.reason")}),("category"!==u.xAxis||"calculatedEmissions"!==u.yAxis)&&e.push({title:m("stage3.chartBuilder.suggestions.emissionsByCategory.title"),description:m("stage3.chartBuilder.suggestions.emissionsByCategory.description"),chartType:"pie",xAxis:"category",yAxis:"calculatedEmissions",aggregation:"sum",reason:m("stage3.chartBuilder.suggestions.emissionsByCategory.reason")}),("reportingPeriodStart"!==u.xAxis||"calculatedEmissions"!==u.yAxis)&&e.push({title:m("stage3.chartBuilder.suggestions.emissionsOverTime.title"),description:m("stage3.chartBuilder.suggestions.emissionsOverTime.description"),chartType:"line",xAxis:"reportingPeriodStart",yAxis:"calculatedEmissions",aggregation:"sum",reason:m("stage3.chartBuilder.suggestions.emissionsOverTime.reason")}),y(e)},[u]);(0,i.useEffect)(()=>{l&&g(l)},[l]),(0,i.useEffect)(()=>{(u.title||u.xAxis||u.yAxis)&&N()},[u.title,u.xAxis,u.yAxis,u.chartType,N]),(0,i.useEffect)(()=>{(u.xAxis||u.yAxis)&&S()},[u.xAxis,u.yAxis,S]);let F=e=>{var t,a;g({...u,title:e.title,chartType:e.chartType,xAxis:e.xAxis,yAxis:e.yAxis,aggregation:e.aggregation,xAxisLabel:(null==(t=x.find(t=>t.key===e.xAxis))?void 0:t.label)||"",yAxisLabel:(null==(a=x.find(t=>t.key===e.yAxis))?void 0:a.label)||""}),r.toast.success(m("stage3.chartBuilder.toast.suggestionApplied"))};return(0,s.jsx)("div",{className:"modal-overlay",children:(0,s.jsxs)("div",{className:"modal-content chart-builder-modal",children:[(0,s.jsxs)("div",{className:"modal-header",children:[(0,s.jsx)("h3",{className:"modal-title",children:l?m("stage3.chartBuilder.editChart"):m("stage3.chartBuilder.createNewChart")}),(0,s.jsx)("button",{onClick:d,className:"btn-close",children:"\xd7"})]}),(0,s.jsx)("div",{className:"modal-body",children:(0,s.jsxs)("div",{className:"chart-builder-form",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"chartTitle",children:[m("stage3.chartBuilder.formLabels.chartTitle")," *"]}),(0,s.jsx)("input",{id:"chartTitle",type:"text",className:"form-input ".concat(h.find(e=>"title"===e.field)?"form-input-error":""),value:u.title,onChange:e=>g({...u,title:e.target.value}),placeholder:m("stage3.chartBuilder.placeholders.enterChartTitle")}),h.find(e=>"title"===e.field)&&(0,s.jsx)("div",{className:"form-error-message",children:null==(t=h.find(e=>"title"===e.field))?void 0:t.message})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"chartType",children:[m("stage3.chartBuilder.formLabels.chartType")," *"]}),(0,s.jsx)("div",{className:"chart-type-options",children:v.map(e=>(0,s.jsxs)("label",{className:"chart-type-option",children:[(0,s.jsx)("input",{type:"radio",name:"chartType",value:e.value,checked:u.chartType===e.value,onChange:e=>g({...u,chartType:e.target.value})}),(0,s.jsxs)("div",{className:"chart-type-info",children:[(0,s.jsx)("span",{className:"chart-type-label",children:e.label}),(0,s.jsx)("span",{className:"chart-type-description",children:e.description})]})]},e.value))})]}),(0,s.jsxs)("div",{className:"form-row",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"xAxis",children:[m("stage3.chartBuilder.formLabels.xAxisField")," *"]}),(0,s.jsxs)("select",{id:"xAxis",className:"form-input ".concat(h.find(e=>"xAxis"===e.field)?"form-input-error":""),value:u.xAxis,onChange:e=>g({...u,xAxis:e.target.value}),children:[(0,s.jsx)("option",{value:"",children:m("stage3.chartBuilder.placeholders.selectXAxisField")}),x.map(e=>(0,s.jsxs)("option",{value:e.key,children:[e.label," (",e.type,")"]},e.key))]}),h.find(e=>"xAxis"===e.field)&&(0,s.jsx)("div",{className:"form-error-message",children:null==(a=h.find(e=>"xAxis"===e.field))?void 0:a.message})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"yAxis",children:[m("stage3.chartBuilder.formLabels.yAxisField")," *"]}),(0,s.jsxs)("select",{id:"yAxis",className:"form-input ".concat(h.find(e=>"yAxis"===e.field)?"form-input-error":""),value:u.yAxis,onChange:e=>g({...u,yAxis:e.target.value}),children:[(0,s.jsx)("option",{value:"",children:m("stage3.chartBuilder.placeholders.selectYAxisField")}),x.map(e=>(0,s.jsxs)("option",{value:e.key,children:[e.label," (",e.type,")"]},e.key))]}),h.find(e=>"yAxis"===e.field)&&(0,s.jsx)("div",{className:"form-error-message",children:null==(n=h.find(e=>"yAxis"===e.field))?void 0:n.message})]})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsxs)("label",{htmlFor:"aggregation",children:[m("stage3.chartBuilder.formLabels.aggregationMethod")," *"]}),(0,s.jsx)("select",{id:"aggregation",className:"form-input",value:u.aggregation,onChange:e=>g({...u,aggregation:e.target.value}),children:b.map(e=>(0,s.jsxs)("option",{value:e.value,children:[e.label," - ",e.description]},e.value))})]}),(0,s.jsxs)("div",{className:"form-row",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"xAxisLabel",children:m("stage3.chartBuilder.formLabels.xAxisLabel")}),(0,s.jsx)("input",{id:"xAxisLabel",type:"text",className:"form-input",value:u.xAxisLabel,onChange:e=>g({...u,xAxisLabel:e.target.value}),placeholder:m("stage3.chartBuilder.placeholders.leaveEmptyForFieldName")})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{htmlFor:"yAxisLabel",children:m("stage3.chartBuilder.formLabels.yAxisLabel")}),(0,s.jsx)("input",{id:"yAxisLabel",type:"text",className:"form-input",value:u.yAxisLabel,onChange:e=>g({...u,yAxisLabel:e.target.value}),placeholder:m("stage3.chartBuilder.placeholders.leaveEmptyForFieldName")})]})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:m("stage3.chartBuilder.formLabels.colorPalette")}),(0,s.jsx)("div",{className:"color-palette-options",children:j.map((e,t)=>(0,s.jsxs)("label",{className:"color-palette-option",children:[(0,s.jsx)("input",{type:"radio",name:"colorPalette",checked:JSON.stringify(u.colors)===JSON.stringify(e),onChange:()=>g({...u,colors:e})}),(0,s.jsx)("div",{className:"color-swatches",children:e.map((e,t)=>(0,s.jsx)("div",{className:"color-swatch",style:{backgroundColor:e}},t))})]},t))})]}),f.length>0&&(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:m("stage3.chartBuilder.formLabels.chartSuggestions")}),(0,s.jsx)("div",{className:"chart-suggestions",children:f.map((e,t)=>(0,s.jsxs)("div",{className:"chart-suggestion",children:[(0,s.jsxs)("div",{className:"suggestion-content",children:[(0,s.jsx)("h4",{children:e.title}),(0,s.jsx)("p",{children:e.description}),(0,s.jsx)("small",{className:"suggestion-reason",children:e.reason})]}),(0,s.jsx)("button",{onClick:()=>F(e),className:"btn btn-secondary btn-small",children:m("stage3.chartBuilder.apply")})]},t))})]}),h.some(e=>"warning"===e.severity)&&(0,s.jsxs)("div",{className:"form-warnings",children:[(0,s.jsx)("h4",{children:m("stage3.chartBuilder.warnings")}),h.filter(e=>"warning"===e.severity).map((e,t)=>(0,s.jsxs)("div",{className:"warning-message",children:["⚠️ ",e.message]},t))]})]})}),(0,s.jsxs)("div",{className:"modal-actions",children:[(0,s.jsx)("button",{onClick:d,className:"btn btn-secondary",children:m("common.cancel")}),(0,s.jsx)("button",{onClick:()=>{var e,t;if(h.some(e=>"error"===e.severity))return void r.toast.error(m("stage3.chartBuilder.toast.fixErrorsBeforeSaving"));c({...u,id:(null==l?void 0:l.id)||"chart-".concat(Date.now()),xAxisLabel:u.xAxisLabel||(null==(e=x.find(e=>e.key===u.xAxis))?void 0:e.label)||"",yAxisLabel:u.yAxisLabel||(null==(t=x.find(e=>e.key===u.yAxis))?void 0:t.label)||""})},className:"btn btn-primary",disabled:!(u.title.trim()&&u.xAxis&&u.yAxis&&!h.some(e=>"error"===e.severity)),children:l?m("stage3.chartBuilder.updateChart"):m("stage3.chartBuilder.createChart")})]})]})})};var C=a(4065);k.t1.register(k.PP,k.kc,k.E8,k.hE,k.m_,k.s$,k.Bs,k.FN,k.No,k.ZT);let I=e=>{let{charts:t,data:a,onEditChart:r,onDeleteChart:n,onDuplicateChart:l}=e,c=(0,o.c3)(),[d,m]=(0,i.useState)(null),[u,g]=(0,i.useState)(t.map(e=>e.id)),[h,p]=(0,i.useState)({}),[f,y]=(0,i.useState)({}),x=(0,i.useRef)({});i.useEffect(()=>{g(t.map(e=>e.id))},[t]);let v=(0,i.useCallback)(e=>{let t=h[e]||[];if(0===t.length)return a;let s=[...a];return t.forEach(e=>{s=s.filter(t=>{let a=t[e.field];return"string"==typeof a?a.toLowerCase().includes(e.value.toLowerCase()):"number"==typeof a&&String(a)===e.value})}),s},[a,h]),b=(0,i.useCallback)((e,t)=>{p(a=>({...a,[e]:[...a[e]||[],t]}))},[]),j=(0,i.useCallback)((e,t)=>{p(a=>({...a,[e]:(a[e]||[]).filter(e=>e.id!==t)}))},[]),N=(0,i.useCallback)(e=>{y(t=>({...t,[e]:!t[e]}))},[]),S=(0,i.useCallback)(e=>{let t=x.current[e];if(!t)return;let a=document.createElement("canvas"),s=a.getContext("2d");if(!s)return;let i=t.getBoundingClientRect();a.width=3*i.width,a.height=3*i.height,s.scale(3,3);let r=t.querySelector("canvas");if(r){let t=document.createElement("a");t.download="chart-".concat(e,".png"),r.toBlob(e=>{if(e){let a=URL.createObjectURL(e);t.href=a,t.click(),URL.revokeObjectURL(a)}},"image/png")}},[]),F=e=>{let t=v(e.id);if(0===t.length)return{labels:["No data"],datasets:[{label:e.yAxis,data:[0],backgroundColor:e.colors[0]||"#2E7D32",borderColor:e.colors[0]||"#2E7D32",borderWidth:1}]};if(("line"===e.chartType||"bar"===e.chartType)&&("reportingPeriodStart"===e.xAxis||"reportingPeriodEnd"===e.xAxis))return E(e,t);let a=new Map;t.forEach(t=>{let s=String(t[e.xAxis]||"Unknown"),i=Number(t[e.yAxis]||0);a.has(s)?a.set(s,a.get(s)+i):a.set(s,i)});let s=Array.from(a.keys()),i=Array.from(a.values());return{labels:s,datasets:[{label:e.yAxisLabel||e.yAxis,data:i,backgroundColor:e.colors.slice(0,i.length),borderColor:e.colors.slice(0,i.length),borderWidth:1}]}},E=(e,t)=>{let a=t.sort((t,a)=>{let s=new Date(t[e.xAxis]),i=new Date(a[e.xAxis]);return s.getTime()-i.getTime()}),s=new Map;a.forEach(t=>{let a=t[e.xAxis],i=Number(t[e.yAxis]||0);if(a){let e=new Date(a).toLocaleDateString();s.has(e)?s.set(e,s.get(e)+i):s.set(e,i)}});let i=Array.from(s.keys()),r=Array.from(s.values());return{labels:i,datasets:[{label:e.yAxisLabel||e.yAxis,data:r,backgroundColor:e.colors[0]||"#2E7D32",borderColor:e.colors[0]||"#2E7D32",borderWidth:2,fill:!1}]}},D=e=>({responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:e.title,font:{size:16,weight:"bold"}},legend:{display:!0,position:"top"},tooltip:{enabled:!0,mode:"index"}}}),k=e=>{let t=F(e),a=D(e);switch(e.chartType){case"bar":default:return(0,s.jsx)(C.yP,{data:t,options:a});case"line":return(0,s.jsx)(C.N1,{data:t,options:a});case"pie":return(0,s.jsx)(C.Fq,{data:t,options:a});case"donut":return(0,s.jsx)(C.nu,{data:t,options:a})}};return 0===t.length?(0,s.jsx)("div",{className:"chart-grid",children:(0,s.jsxs)("div",{className:"chart-grid-header",children:[(0,s.jsx)("h3",{className:"section-title",children:c("stage3.chartGrid.analyticsCharts")}),(0,s.jsx)("p",{className:"section-description",children:c("stage3.chartGrid.noChartsCreatedYet")})]})}):(0,s.jsxs)("div",{className:"chart-grid",children:[(0,s.jsxs)("div",{className:"chart-grid-header",children:[(0,s.jsx)("h3",{className:"section-title",children:c("stage3.chartGrid.analyticsCharts")}),(0,s.jsx)("p",{className:"section-description",children:c("stage3.chartGrid.chartCountDescription",{count:t.length})})]}),(0,s.jsx)("div",{className:"chart-grid-container",children:u.map(e=>{var a;let i=t.find(t=>t.id===e);return i?(0,s.jsxs)("div",{id:"chart-".concat(i.id),ref:e=>{x.current[i.id]=e},className:"chart-card ".concat(d===i.id?"dragging":""),draggable:!0,onDragStart:e=>{m(i.id),e.dataTransfer.setData("text/plain",i.id)},onDragEnd:()=>m(null),onDragOver:e=>e.preventDefault(),onDrop:e=>{e.preventDefault();let t=e.dataTransfer.getData("text/plain");if(t&&t!==i.id){let e=[...u],a=e.indexOf(t),s=e.indexOf(i.id);e.splice(a,1),e.splice(s,0,t),g(e)}},children:[(0,s.jsxs)("div",{className:"chart-header",children:[(0,s.jsx)("h4",{className:"chart-title",children:i.title}),(0,s.jsxs)("div",{className:"chart-actions",children:[(0,s.jsxs)("button",{onClick:()=>N(i.id),className:"btn btn-small btn-secondary",title:c("stage3.chartGrid.toggleFilters"),children:["\uD83D\uDD0D ",(null==(a=h[i.id])?void 0:a.length)||0]}),(0,s.jsx)("button",{onClick:()=>S(i.id),className:"btn btn-small btn-secondary",title:c("stage3.chartGrid.downloadAsPNG"),children:"\uD83D\uDCE5"}),(0,s.jsx)("button",{onClick:()=>r(i),className:"btn btn-small btn-primary",title:c("stage3.chartGrid.editChart"),children:"✏️"}),(0,s.jsx)("button",{onClick:()=>l(i),className:"btn btn-small btn-secondary",title:c("stage3.chartGrid.duplicateChart"),children:"\uD83D\uDCCB"}),(0,s.jsx)("button",{onClick:()=>n(i.id),className:"btn btn-small btn-danger",title:c("stage3.chartGrid.deleteChart"),children:"\uD83D\uDDD1️"})]})]}),f[i.id]&&(0,s.jsx)("div",{className:"chart-filters",children:(0,s.jsx)(w,{chartId:i.id,filters:h[i.id]||[],onAddFilter:b,onRemoveFilter:j})}),(0,s.jsx)("div",{className:"chart-content",children:k(i)})]},i.id):null})}),t.length>1&&(0,s.jsx)("div",{className:"chart-grid-help",children:(0,s.jsxs)("p",{children:["\uD83D\uDCA1 ",(0,s.jsxs)("strong",{children:[c("stage3.chartGrid.tip"),":"]})," ",c("stage3.chartGrid.dragChartsToReorder")]})})]})},w=e=>{let{chartId:t,filters:a,onAddFilter:r,onRemoveFilter:n}=e,l=(0,o.c3)(),[c,d]=(0,i.useState)({field:"",operator:"contains",value:""}),m=[{key:"activityName",label:l("stage2.formLabels.activityName")},{key:"reportingPeriodStart",label:l("stage2.formLabels.reportingPeriodStart")},{key:"reportingPeriodEnd",label:l("stage2.formLabels.reportingPeriodEnd")},{key:"scope",label:l("stage2.formLabels.scope")},{key:"category",label:l("stage2.formLabels.category")},{key:"location",label:l("stage2.formLabels.location")},{key:"quantity",label:l("stage2.formLabels.quantity")},{key:"emissionFactorId",label:l("stage2.formLabels.emissionFactorId")},{key:"calculatedEmissions",label:l("stage2.formLabels.calculatedEmissions")}],u=[{value:"contains",label:l("stage3.chartGrid.operators.contains")},{value:"equals",label:l("stage3.chartGrid.operators.equals")},{value:"startsWith",label:l("stage3.chartGrid.operators.startsWith")},{value:"endsWith",label:l("stage3.chartGrid.operators.endsWith")}];return(0,s.jsxs)("div",{className:"chart-filters-container",children:[(0,s.jsxs)("div",{className:"filters-header",children:[(0,s.jsx)("h5",{children:l("stage3.chartGrid.filters.chartFilters")}),(0,s.jsx)("small",{children:l("stage3.chartGrid.filters.filterDataForThisChartOnly")})]}),(0,s.jsxs)("div",{className:"add-filter-form",children:[(0,s.jsxs)("select",{value:c.field,onChange:e=>d({...c,field:e.target.value}),className:"form-input",children:[(0,s.jsx)("option",{value:"",children:l("stage3.chartGrid.filters.selectField")}),m.map(e=>(0,s.jsx)("option",{value:e.key,children:e.label},e.key))]}),(0,s.jsx)("select",{value:c.operator,onChange:e=>d({...c,operator:e.target.value}),className:"form-input",children:u.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))}),(0,s.jsx)("input",{type:"text",value:c.value,onChange:e=>d({...c,value:e.target.value}),placeholder:l("stage3.chartGrid.filters.enterValue"),className:"form-input"}),(0,s.jsx)("button",{onClick:()=>{c.field&&c.value&&(r(t,{id:"filter-".concat(Date.now()),field:c.field,operator:c.operator,value:c.value}),d({field:"",operator:"contains",value:""}))},className:"btn btn-small btn-primary",disabled:!c.field||!c.value,children:l("stage3.chartGrid.filters.addFilter")})]}),a.length>0&&(0,s.jsx)("div",{className:"active-filters",children:a.map(e=>{var a;return(0,s.jsxs)("div",{className:"filter-pill",children:[(0,s.jsxs)("span",{className:"filter-text",children:[null==(a=m.find(t=>t.key===e.field))?void 0:a.label," ",e.operator,' "',e.value,'"']}),(0,s.jsx)("button",{onClick:()=>n(t,e.id),className:"btn-remove-filter",title:l("stage3.chartGrid.filters.removeFilter"),children:"\xd7"})]},e.id)})})]})};k.t1.register(k.PP,k.kc,k.E8,k.hE,k.m_,k.s$,k.Bs,k.FN,k.No,k.ZT);let R=()=>{let e=(0,o.c3)(),[t,a]=(0,i.useState)([]),[n,l]=(0,i.useState)([]),[c,d]=(0,i.useState)(!0),[m,u]=(0,i.useState)([]),[g,h]=(0,i.useState)(!1),[p,f]=(0,i.useState)(null),[y,x]=(0,i.useState)([]),b=(0,i.useCallback)(()=>[{id:"default-1",title:e("stage3.defaultCharts.emissionsByScope"),chartType:"bar",xAxis:"scope",yAxis:"calculatedEmissions",aggregation:"sum",xAxisLabel:e("stage2.formLabels.scope"),yAxisLabel:e("stage3.defaultCharts.emissionsYAxisLabel"),colors:["#2E7D32","#4CAF50","#8BC34A","#CDDC39"],isDefault:!0}],[]),j=(0,i.useCallback)(()=>{try{let e=localStorage.getItem("carbon-hub-charts");if(e){let t=JSON.parse(e);u(t)}else u(b())}catch(e){console.error("Error loading saved charts:",e),u(b())}},[b]),N=(0,i.useCallback)(t=>{try{localStorage.setItem("carbon-hub-charts",JSON.stringify(t)),u(t)}catch(t){console.error("Error saving charts:",t),r.toast.error(e("stage3.toast.saveChartConfigurationFailed"))}},[]),S=async()=>{try{let[e,t]=await Promise.all([v.getAllReportingActivities(),v.getAllEmissionFactors()]);a(e),l(t)}catch(t){console.error("Error fetching data:",t),r.toast.error(e("stage3.toast.fetchReportDataFailed"))}finally{d(!1)}},F=(0,i.useCallback)(()=>{x([...t])},[t]);(0,i.useEffect)(()=>{S(),j()},[j]),(0,i.useEffect)(()=>{F()},[t,F]);let E=(e,t)=>{if(null==t?void 0:t.emissionFactorData)return"".concat(t.emissionFactorData.description," (").concat(t.emissionFactorData.co2ePerUnit," ").concat(t.emissionFactorData.emissionFactorUnit,")");let a=n.find(t=>t._id===e);return a?"".concat(a.description," (").concat(a.co2ePerUnit," ").concat(a.emissionFactorUnit,")"):""},D=(0,i.useCallback)(t=>[[e("stage2.formLabels.activityName"),e("stage2.formLabels.reportingPeriodStart"),e("stage2.formLabels.reportingPeriodEnd"),e("stage2.formLabels.scope"),e("stage2.formLabels.category"),e("stage2.formLabels.location"),e("stage2.formLabels.quantity"),e("stage2.formLabels.emissionFactorId"),e("stage2.formLabels.remarks"),e("stage2.formLabels.calculatedEmissions")],...t.map(e=>{var t;return[e.activityName,e.reportingPeriodStart,e.reportingPeriodEnd,e.scope,e.category,e.location,e.quantity,E(e.emissionFactorId||"",e),e.remarks||"",(null==(t=e.calculatedEmissions)?void 0:t.toFixed(2))||"0"]})].map(e=>e.map(e=>'"'.concat(e,'"')).join(",")).join("\n"),[n]),k=(0,i.useCallback)((t,a)=>{let s=new Blob([t],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),o=URL.createObjectURL(s);i.setAttribute("href",o),i.setAttribute("download",a),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i),r.toast.success(e("stage3.toast.csvExportedSuccessfully"))},[]);return c?(0,s.jsxs)("div",{className:"stage",children:[(0,s.jsx)("h2",{className:"stage-title",children:e("stage3.title")}),(0,s.jsx)("div",{className:"loading",children:e("common.loading")})]}):(0,s.jsxs)("div",{className:"stage",children:[(0,s.jsx)("h2",{className:"stage-title",children:e("stage3.title")}),(0,s.jsxs)("div",{className:"dashboard-actions",children:[(0,s.jsxs)("button",{onClick:()=>h(!0),className:"btn btn-primary",children:["+ ",e("stage3.createNewChart")]}),(0,s.jsx)("button",{onClick:()=>{u(b()),N(b()),r.toast.success(e("stage3.toast.resetToDefaultCharts"))},className:"btn btn-secondary",children:e("stage3.resetToDefaults")})]}),(0,s.jsx)(I,{charts:m,data:t,onEditChart:e=>{f(e),h(!0)},onDeleteChart:t=>{N(m.filter(e=>e.id!==t)),r.toast.success(e("stage3.toast.chartDeletedSuccessfully"))},onDuplicateChart:t=>{N([...m,{...t,id:"chart-".concat(Date.now()),title:"".concat(t.title," ").concat(e("stage3.chartCopySuffix")),isDefault:!1}]),r.toast.success(e("stage3.toast.chartDuplicatedSuccessfully"))}}),g&&(0,s.jsx)(A,{chartConfig:p,onSave:p?t=>{N(m.map(e=>e.id===t.id?t:e)),h(!1),f(null),r.toast.success(e("stage3.toast.chartUpdatedSuccessfully"))}:t=>{N([...m,{...t,id:"chart-".concat(Date.now()),isDefault:!1}]),h(!1),f(null),r.toast.success(e("stage3.toast.chartAddedSuccessfully"))},onCancel:()=>{h(!1),f(null)}}),(0,s.jsxs)("div",{className:"data-section",children:[(0,s.jsxs)("div",{className:"table-header",children:[(0,s.jsx)("h3",{className:"section-title",children:e("stage3.detailedDataExport")}),(0,s.jsx)("button",{onClick:()=>{k(D(y),"emissions_analytics.csv")},className:"btn btn-secondary",children:e("stage3.exportFilteredData")})]}),(0,s.jsx)("div",{className:"table-container",children:y.length>0?(0,s.jsxs)("table",{className:"data-table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:e("stage2.formLabels.activityName")}),(0,s.jsx)("th",{children:e("stage2.formLabels.reportingPeriodStart")}),(0,s.jsx)("th",{children:e("stage2.formLabels.reportingPeriodEnd")}),(0,s.jsx)("th",{children:e("stage2.formLabels.scope")}),(0,s.jsx)("th",{children:e("stage2.formLabels.category")}),(0,s.jsx)("th",{children:e("stage2.formLabels.location")}),(0,s.jsx)("th",{children:e("stage2.formLabels.quantity")}),(0,s.jsx)("th",{children:e("stage2.formLabels.emissionFactorId")}),(0,s.jsx)("th",{children:e("stage2.formLabels.remarks")}),(0,s.jsx)("th",{children:e("stage2.formLabels.calculatedEmissions")})]})}),(0,s.jsx)("tbody",{children:y.map(e=>{var t;return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.activityName}),(0,s.jsx)("td",{children:e.reportingPeriodStart}),(0,s.jsx)("td",{children:e.reportingPeriodEnd}),(0,s.jsx)("td",{children:e.scope}),(0,s.jsx)("td",{children:e.category}),(0,s.jsx)("td",{children:e.location}),(0,s.jsx)("td",{children:e.quantity}),(0,s.jsx)("td",{children:E(e.emissionFactorId||"",e)}),(0,s.jsx)("td",{children:e.remarks||"-"}),(0,s.jsx)("td",{children:null==(t=e.calculatedEmissions)?void 0:t.toFixed(2)})]},e._id)})}),(0,s.jsx)("tfoot",{children:(0,s.jsxs)("tr",{className:"total-row",children:[(0,s.jsx)("td",{colSpan:9,children:(0,s.jsx)("strong",{children:e("stage3.totalEmissions")})}),(0,s.jsx)("td",{children:(0,s.jsxs)("strong",{children:[y.reduce((e,t)=>e+(t.calculatedEmissions||0),0).toFixed(2)," kg CO2e"]})})]})})]}):(0,s.jsx)("div",{className:"no-data",children:e("stage3.noActivitiesFound")})})]})]})},T=()=>(0,s.jsx)(R,{}),B=e=>{let{isOpen:t,onExtendSession:a,onClearData:r,timeRemaining:n}=e,l=(0,o.c3)(),[c,d]=(0,i.useState)(n);if((0,i.useEffect)(()=>{if(t){document.body.style.overflow="hidden",document.body.style.pointerEvents="none";let e=document.querySelector(".modal-content");e&&(e.style.pointerEvents="auto")}else document.body.style.overflow="",document.body.style.pointerEvents="";return()=>{document.body.style.overflow="",document.body.style.pointerEvents=""}},[t]),(0,i.useEffect)(()=>{if(!t)return;let e=setInterval(()=>{d(e=>e<=1e3?(r(),0):e-1e3)},1e3);return()=>clearInterval(e)},[t,r]),(0,i.useEffect)(()=>{d(n)},[n]),!t)return null;let m=e=>{let t=Math.floor(e/6e4),a=Math.floor(e%6e4/1e3);return"".concat(t,":").concat(a.toString().padStart(2,"0"))},u=()=>(6e5-c)/6e5*100;return(0,s.jsx)("div",{className:"modal-overlay inactivity-modal-overlay",children:(0,s.jsxs)("div",{className:"modal-content inactivity-modal-content",children:[(0,s.jsxs)("div",{className:"modal-header",children:[(0,s.jsx)("h2",{className:"modal-title",children:l("inactivityModal.title")}),(0,s.jsxs)("div",{className:"countdown-container",children:[(0,s.jsx)("div",{className:"countdown-timer",children:l("inactivityModal.message",{timeRemaining:m(c)})}),(0,s.jsx)("div",{className:"countdown-progress",children:(0,s.jsx)("div",{className:"countdown-progress-bar",style:{width:"".concat(u(),"%"),backgroundColor:(()=>{let e=u();return e<50?"var(--success)":e<80?"var(--accent)":"var(--error)"})()}})})]})]}),(0,s.jsxs)("div",{className:"modal-body",children:[(0,s.jsx)("div",{className:"warning-icon",children:"⚠️"}),(0,s.jsx)("p",{className:"modal-message",children:l("inactivityModal.message",{timeRemaining:m(c)})}),(0,s.jsxs)("div",{className:"modal-options",children:[(0,s.jsx)("p",{children:"What would you like to do?"}),(0,s.jsxs)("ul",{children:[(0,s.jsxs)("li",{children:[(0,s.jsx)("strong",{children:"Need more time:"})," Keep your data and reset the timer"]}),(0,s.jsxs)("li",{children:[(0,s.jsx)("strong",{children:"Clear all records:"})," Delete all your input data now"]})]})]})]}),(0,s.jsxs)("div",{className:"modal-actions",children:[(0,s.jsx)("button",{onClick:a,className:"btn btn-primary modal-btn",children:l("inactivityModal.extendSession")}),(0,s.jsx)("button",{onClick:r,className:"btn btn-secondary modal-btn",children:l("inactivityModal.clearData")})]}),(0,s.jsx)("div",{className:"modal-footer",children:(0,s.jsx)("small",{children:l("dataRetention.description",{inactivityMinutes:20,modalMinutes:10})})})]})})};class q{generateSessionId(){return"session_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}initializeSession(){let e=localStorage.getItem("carbonHubSession");if(e)try{let t=JSON.parse(e);Date.now()-t.lastActivity<864e5?(this.sessionId=t.sessionId,this.updateActivity()):this.createNewSession()}catch(e){this.createNewSession()}else this.createNewSession()}createNewSession(){let e={sessionId:this.sessionId,lastActivity:Date.now(),isModalOpen:!1};localStorage.setItem("carbonHubSession",JSON.stringify(e))}setupActivityListeners(){["mousedown","mousemove","keypress","scroll","touchstart","click"].forEach(e=>{document.addEventListener(e,()=>this.updateActivity(),{passive:!0})}),document.addEventListener("input",()=>this.updateActivity(),{passive:!0}),document.addEventListener("change",()=>this.updateActivity(),{passive:!0})}updateActivity(){let e=this.getSessionData();e.lastActivity=Date.now(),e.isModalOpen=!1,e.modalStartTime=void 0,this.saveSessionData(e),this.resetInactivityTimer(),this.clearModalTimer()}resetInactivityTimer(){this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.inactivityTimer=setTimeout(()=>{this.showInactivityWarning()},this.INACTIVITY_TIMEOUT)}showInactivityWarning(){let e=this.getSessionData();e.isModalOpen=!0,e.modalStartTime=Date.now(),this.saveSessionData(e),this.onInactivityWarning&&this.onInactivityWarning(),this.modalTimer=setTimeout(()=>{this.cleanupData()},this.MODAL_TIMEOUT)}extendSession(){this.updateActivity();let e=Math.floor(this.INACTIVITY_TIMEOUT/6e4);r.toast.success("Session extended! Your data is safe for another ".concat(e," minutes."))}async cleanupData(){this.onDataCleanup&&this.onDataCleanup(),localStorage.removeItem("carbonHubSession"),this.createNewSession(),r.toast.success("All data has been cleared due to inactivity.")}clearModalTimer(){this.modalTimer&&(clearTimeout(this.modalTimer),this.modalTimer=null)}getSessionData(){let e=localStorage.getItem("carbonHubSession");return e?JSON.parse(e):{sessionId:this.sessionId,lastActivity:Date.now(),isModalOpen:!1}}saveSessionData(e){localStorage.setItem("carbonHubSession",JSON.stringify(e))}getSessionId(){return this.sessionId}isModalOpen(){return this.getSessionData().isModalOpen||!1}getModalTimeRemaining(){let e=this.getSessionData();if(!e.modalStartTime)return 0;let t=Date.now()-e.modalStartTime;return Math.max(0,this.MODAL_TIMEOUT-t)}getInactivityTimeout(){return this.INACTIVITY_TIMEOUT}getModalTimeout(){return this.MODAL_TIMEOUT}setInactivityWarningCallback(e){this.onInactivityWarning=e}setDataCleanupCallback(e){this.onDataCleanup=e}destroy(){this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.modalTimer&&clearTimeout(this.modalTimer)}constructor(){this.inactivityTimer=null,this.modalTimer=null,this.onInactivityWarning=null,this.onDataCleanup=null,this.INACTIVITY_TIMEOUT=12e5,this.MODAL_TIMEOUT=6e5,this.sessionId=this.generateSessionId(),this.initializeSession(),this.setupActivityListeners()}}function O(){let e=(0,o.c3)(),[t,a]=(0,i.useState)(1),[n,l]=(0,i.useState)(null),[c,u]=(0,i.useState)(!1),[g,h]=(0,i.useState)(0),[p,f]=(0,i.useState)(20),[y,x]=(0,i.useState)(10);(0,i.useEffect)(()=>{let e=new q;return l(e),f(Math.floor(e.getInactivityTimeout()/6e4)),x(Math.floor(e.getModalTimeout()/6e4)),e.setInactivityWarningCallback(()=>{u(!0),h(e.getModalTimeRemaining())}),e.setDataCleanupCallback(async()=>{try{await v.clearAllData(),window.location.reload()}catch(e){console.error("Error clearing data:",e)}}),()=>{e.destroy()}},[]),(0,i.useEffect)(()=>{if(c&&n){let e=setInterval(()=>{h(n.getModalTimeRemaining())},1e3);return()=>clearInterval(e)}},[c,n]);let b=()=>{t<3&&a(t+1)},j=async()=>{n&&(n.cleanupData(),u(!1))};return(0,s.jsxs)("div",{className:"app",children:[(0,s.jsx)(r.Toaster,{position:"top-right"}),(0,s.jsxs)("div",{className:"container",children:[(0,s.jsx)(d,{}),(0,s.jsx)(m,{currentStage:t,onStageClick:e=>{a(e)}}),(0,s.jsx)("main",{className:"main-content",children:(()=>{switch(t){case 1:default:return(0,s.jsx)(S,{onNext:b});case 2:return(0,s.jsx)(D,{onNext:b});case 3:return(0,s.jsx)(T,{})}})()}),(0,s.jsx)("div",{className:"data-retention-notice",children:(0,s.jsxs)("p",{children:[(0,s.jsx)("strong",{children:e("dataRetention.note")})," ",e("dataRetention.description",{inactivityMinutes:p,modalMinutes:y})]})})]}),(0,s.jsx)(B,{isOpen:c,onExtendSession:()=>{n&&(n.extendSession(),u(!1))},onClearData:j,timeRemaining:g})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[768,711,647,96,557,642,441,684,358],()=>t(1311)),_N_E=e.O()}]);